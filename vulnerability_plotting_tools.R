
# Vulnerability plotting tools ----

# Imports ----
require(parallel)
require(reshape2)

require(ggplot2)
#library(magick)
library(grid)

require(plyr)
require(dplyr)

require(pals)

# Data ----
H37Rv_SGRNA_DATA_FILE = "clean_data_H37Rv_ref_10_14_2020.txt"
HN878_SGRNA_DATA_FILE = "clean_data_HN878_ref_10_14_2020.txt"
Smeg_SGRNA_DATA_FILE = "clean_data_Smeg_ref_10_14_2020.txt"


H37Rv_SGRNA_FIT_FILE = "result_sgrna_fit_2line_H37Rv_ref.txt"
HN878_SGRNA_FIT_FILE = "result_sgrna_fit_2line_HN878ref.txt"
Smeg_SGRNA_FIT_FILE = "result_sgrna_fit_2line_Smeg_ref.txt"


H37Rv_VULN_DATA_FILE = "prelim_vuln_H37Rv_ref_10_14_2020.txt"
HN878_VULN_DATA_FILE = "prelim_vuln_HN878_ref_10_14_2020.txt"
Smeg_VULN_DATA_FILE = "prelim_vuln_Smeg_ref_10_14_2020.txt"


H37Rv_REF_LABEL = "H37Rv_ref_10_14_2020"
HN878_REF_LABEL = "HN878_ref_10_14_2020"
SMEG_REF_LABEL = "Smeg_ref_10_14_2020"



# Colors  ----

# Global color variables
BLACK = "#000000"
DARKGRAY = "#747474"
ORANGE = "#E69F00"
LIGHTBLUE = "#56B4E9"
GREEN = "#009E73"
YELLOW = "#F0E442"
BLUE = "#0072B2"
RED = "#D55E00"
PINK = "#CC79A7"
PURPLE = "#3D348B"

VULN_COLOR_OLD = "#FD8D3C"
INV_COLOR_OLD = "#969696"

VULN_COLOR = "#6A51A3"
INV_COLOR = "#969696"

CLUSTER_BLUE = "#1f84ff"

ES_COLOR = RED
UN_COLOR = PURPLE
NE_COLOR = BLUE

GRAY = "#7B848F"
BROWN = "#C85200"
TAN = "#FFBC79"

LIGHTGRAY = "#D6CFC7"
GRAY2 = "#787276"
SUPERDARKGRAY = "#222021"

BLACK_BORDER = "#747474"
DARKGRAY_BORDER = "#525151"
ORANGE_BORDER = "#E68A00"
LIGHTBLUE_BORDER = "#569BE9"
GREEN_BORDER = "#017C5B"
YELLOW_BORDER = "#F0CD42"
BLUE_BORDER = "#035A8C"
RED_BORDER = "#B83502"
PINK_BORDER = "#bd6f73"


fill_palette <- c(BLACK, RED, BLUE, GREEN)
border_palette <- c(BLACK_BORDER, RED_BORDER, BLUE_BORDER, GREEN_BORDER)


# Global limit variables

# BETA_E_BOTTOM = -0.45
# BETA_E_TOP = 0.05
# Y_MIN = -6
# Y_MAX = 1

BETA_E_BOTTOM = -1.05
BETA_E_TOP = 0.05

PREDLOGFC_BOTTOM = -28.05
PREDLOGFC_TOP = 1.05

#
Y_MIN = -14.5
Y_MAX = 1

RATIO_MIN =-5.0
RATIO_MAX = 0.5

# Settings  ----
#THEME_AXIS_FONT_SIZE = 15
#THEME_TITLE_FONT_SIZE = 18

THEME_AXIS_FONT_SIZE = 22
THEME_TITLE_FONT_SIZE = 25

# Setting up ggplot theme
theme_set(theme_bw())
theme_update(axis.text = element_text(size=THEME_AXIS_FONT_SIZE), title = element_text(size=THEME_TITLE_FONT_SIZE),
             axis.title.y  = element_text(size=THEME_AXIS_FONT_SIZE, margin = margin(t = 0, r = 10, b = 0, l = 0)),
             axis.title.x  = element_text(size=THEME_AXIS_FONT_SIZE, margin = margin(t = 10, r = 0, b = 0, l = 0)),
             panel.grid.major = element_blank(),
             panel.grid.minor = element_blank(), panel.border = element_rect(size=2),
             legend.text = element_text(size=THEME_AXIS_FONT_SIZE))


# Functions  ----


clean_string = function(X){
  return(gsub(":", "_", X))
}



pam_motifs = c("NNAGAAG","NNAGAAT","NNAGAAA","NNGGAAG","NNAGAAC",
               "NNGGAAA","NNAGCAT","NNAGGAG","NNAGGAT","NNAGCAA",
               "NNGGAAC","NNGGAAT","NNAGCAG","NNAGGAA","NNAGGAC",
               "NNGGGAG","NNGGGAT","NNGGGAA","NNAGCAC","NNGGGAC",
               "NNGGCAT","NNGGCAG","NNGGCAA","NNGGCAC", "")


old_pams = c(1, 2, 3, 4, 5,
             6, 7, 8, 9, 10,
             11,12,13,14,15,
             16,17,18,19,20,
             21,22,23,24, NA)


new_pams = c(3,1,2,6,7,
             5,11,13,8,9,
             10,4,15,12,14,
             19,16,17,18,21,
             20,23,22,24,NA)


# pam_motifs = c("NNAGAAA",  "",  "NNAGAAC",  
#                "NNGGCAT",  "NNAGAAG",  "NNAGCAT",  
#                "NNGGCAA",  "NNGGCAC",  "NNAGAAT",  
#                "NNGGCAG",  "NNAGCAG",  "NNAGCAC",  
#                "NNAGCAA",  "NNGGAAG",  "NNGGGAT",  
#                "NNGGAAC",  "NNGGAAA",  "NNAGGAT",  
#                "NNAGGAC",  "NNAGGAA",  "NNGGAAT",  
#                "NNGGGAA",  "NNGGGAC",  "NNGGGAG",  
#                "NNAGGAG")
# 
# old_pams = c(3,  NA,  5,  
#              21,  1,  7,  
#              23,  24,  2,  
#              22,  13,  19,  
#              10,  4,  17,  
#              11,  6,  9,  
#              15,  14,  12,  
#              18,  20,  16,
#              8)
# 
# new_pams = c(2,  NA,  6,
#              20,  4,  9,
#              21,  24,  1,
#              23,  15,  18,
#              12,  7,  16,
#              13,  5,  8,
#              14,  11,  3,
#              17,  22,  19,
#              10)




norm_to_unit = function(x, min_x=NULL, max_x=NULL){
  if (is.null(min_x)){
    min_x = numpy.min(x)
  }
  if(is.null(max_x)){
    max_x = numpy.max(x)
  }
return ((x - min_x) / (max_x - min_x))
}

convert_new_to_old_pam = function(PAM){
  return(plyr::mapvalues(PAM, new_pams, old_pams, warn_missing = FALSE))
}

convert_new_to_old_pam_seq = function(PAM){
  return(plyr::mapvalues(PAM, new_pams, pam_motifs, warn_missing = FALSE))
}

convert_old_to_new_pam = function(PAM){
  return(plyr::mapvalues(PAM, old_pams, new_pams, warn_missing = FALSE))
}

convert_old_to_new_pam_seq = function(PAM){
  return(plyr::mapvalues(PAM, old_pams, pam_motifs, warn_missing = FALSE))
}

seq_from_id = function(IDs){
  seqs = c()
  for(id in IDs){
    s = strsplit(id, "_")[[1]][3]
    seqs = c(seqs, s)
  }
  return(seqs)
}


get_orf_id_from_gene = function(gene){
  return(strsplit(gene, ":")[[1]][1])
}

get_orf_id_from_gene_list = function(gene_list){
  orf_id_list = c()
  for(gene in gene_list){
    orf_id_list = c(orf_id_list, get_orf_id_from_gene(gene))
  }
  return (orf_id_list)
}


get_name_from_gene = function(gene){
  temp = strsplit(gene, ":")[[1]]
  pos = 2
  if (length(temp) == 1){ pos = 1}
  return(temp[pos])
  
}

get_name_from_gene_list = function(gene_list){
  name_list = c()
  for (gene in gene_list){
    name_list = c(name_list, get_name_from_gene(gene))
  }
  return(name_list)
}


find_name_from_id = function(id, data){
  ii_match = data$ORFID == id
  return(data$NAME[ii_match][1])
}

find_id_from_name = function(name, data){
  ii_match = data$NAME == name
  return(data$ORFID[ii_match][1])
}

get_clean_gene_list = function(raw_gene_list, data){


  clean_gene_list = c()
  for(raw_gene in raw_gene_list){
    # It it's nicely named:
    if (":" %in% raw_gene){
      clean_id = strsplit(raw_gene, ":")[[1]][1]
      clean_name = strsplit(raw_gene, ":")[[1]][2]
      clean_gene = paste(clean_id, clean_name, sep=":")
    } else if ("Negative" %in% raw_gene){
      clean_id = "Negative"
      clean_name = "Negative"
      clean_gene = clean_id
      # Else if it's not a full name, check if it's an ID and get name
    } else if (raw_gene %in% data$ORF){
        clean_id = raw_gene
        clean_name = find_name_from_id(clean_id, data)
        clean_gene = paste(clean_id, clean_name, sep=":")
      # Else check if it's name and get ID
    } else if (raw_gene %in% data$NAME){ 
      clean_name = raw_gene
      clean_id = find_id_from_name(clean_name, data)
      clean_gene = paste(clean_id, clean_name, sep=":")
    } else {
      clean_gene = raw_gene
    }
    clean_gene_list = c(clean_gene_list, clean_gene)
  }

  return (clean_gene_list)

}


data_summary_mean <- function(x) {
  m <- mean(x)
  ymin <- m-sd(x)
  ymax <- m+sd(x)
  return(c(y=m,ymin=ymin,ymax=ymax))
}

data_summary_median <- function(x) {
  Q = quantile(x, na.rm=TRUE)
  return(c(y=Q[[3]], ymin=Q[[2]] ,ymax=Q[[4]]) )
}


get_gene_samples_path = function(gene, label="", basedir="./"){
  clean_gene = gsub(":", "_", gene)
  
  full_label = clean_gene
  if(label !="") {
    full_label = paste(clean_gene, label, sep="_")
  }
  filename =  paste0("sample_nb_logistic_fit_", full_label, ".txt")
  path = file.path(basedir, "samples", filename)
  return(path)
}


get_gene_model_data_path = function(gene, label="", basedir="./"){
  clean_gene = gsub(":", "_", gene)
  full_label = clean_gene
  if(label !="") {
    full_label = paste(clean_gene, label, sep="_")
  }
  filename =  paste("model_data_", full_label, ".Rds", sep="")
  path = file.path(basedir, "model_data", filename)
  return(path)
}


lm_eqn <- function(df, formula){
  m <- lm(formula, df);
  eq <- substitute(italic(y) == a + b %.% italic(x)*","~~italic(r)^2~"="~r2, 
                   list(a = format(unname(coef(m)[1]), digits = 3),
                        b = format(unname(coef(m)[2]), digits = 3),
                        r2 = format(summary(m)$r.squared, digits = 3)))
  as.character(as.expression(eq));
}



get_vuln_modeling_data_and_samples = function(gene, exp, strain, date, basedir){
  
  
  sample_path = get_gene_samples_path(gene, label=strain, basedir=basedir)
  model_data_path = get_gene_model_data_path(gene, label=strain, basedir=basedir)
  
  
  fit_samples = read.csv(sample_path, comment.char="#")
  model_data = readRDS(model_data_path)
  
  if(!("beta_min"%in%colnames(fit_samples))){
    fit_samples["beta_min"] = 0
  }
  
  model_data[["gene"]] = gene
  model_data[["strain"]] = strain
  return(list(fit_samples=fit_samples, model_data=model_data))
}



get_gene_comparisons_list = function(unique_genes, strains, experiments, dates,
                                     labels, directories){
  N = length(unique_genes)
  J = length(strains)
  desired_gene_comparisons = list()
  for(i in 1:N){
    
    message(unique_genes[i])
    if(class(unique_genes[i]) == "character") {
      gene_list = rep(unique_genes[i], J)
    } else {
      gene_list = unique_genes[[i]]
    }
    comparison = list()
    # loop through strains/experiments
    for(j in 1:J){
      
      gene = gene_list[j]
      name = strsplit(gene, ":")[[1]][2]
      
      temp = get_vuln_modeling_data_and_samples(gene, experiments[j],  strains[j], dates[j], directories[j])
      comparison[[j]] = list( gene=gene, name=name, 
            strain=strains[j], exp=experiments[j], date=dates[j],
            label=paste0(name, " - ", labels[j]),  dir=directories[j],
           fit_samples=temp$fit_samples, model_data=temp$model_data

      )
    }
    # add the comparison to desired list
    desired_gene_comparisons[[i]] = comparison
    
  }
  return(desired_gene_comparisons)
}



get_gene_comparisons_list_diff_genes = function(unique_genes_comparisons, strains, experiments, dates,
                                     labels, directories){
  N = length(unique_genes)
  J = length(strains)
  desired_gene_comparisons = list()
  for(i in 1:N){
    message(unique_genes[i])
    gene_list = unique_genes[i]
    name = strsplit(gene, ":")[[1]][2]
    
    comparison = list()
    
    # loop through strains/experiments
    for(j in 1:J){
      
      temp = get_vuln_modeling_data_and_samples(gene_list[i], experiments[j],  strains[j], dates[j], directories[j])
      comparison[[j]] = list( gene=gene_list[i], name=name, 
                              strain=strains[j], exp=experiments[j], date=dates[j],
                              label=paste0(name, " - ", labels[j]),  dir=directories[j],
                              fit_samples=temp$fit_samples, model_data=temp$model_data
                              
      )
    }
    # add the comparison to desired list
    desired_gene_comparisons[[i]] = comparison
    
  }
  return(desired_gene_comparisons)
}






# Function to compare 2+ genes
plot_comparisons = function(X, label="", prefix=".", 
                            output_prefix="./plots/comparisons",
                            fill_palette = c("#747474", "#D55E00"),
                            border_palette = c("#747474", "#D55E00"), full_label="", 
                            width=NULL, height=NULL,
                            style="std", band_alpha=0.3, str_resolution = 0.1,
                            summary_size=4, samples=1000,
                            min_max_path=NULL,
                            data_dir="./data/",
                            plot_dir="./plots/", target="beta_e"){
 

  default_fill = c("#747474", "#D55E00")
  default_border = c("#747474", "#D55E00")
  comparison_list = NULL
  i = 0
  fill_palette_list = c()
  border_palette_list = c()
  full_label_list = c()
  for(geneX in X){
    
    
    clean_gene = gsub(":", "_", geneX$gene)
    #message("Strain: ", geneX$strain, "  Gene: ", geneX$gene)
    #message(sprintf("prefix: %s", prefix))
    
    sample_path = get_gene_samples_path(clean_gene, geneX$strain, geneX$data_dir)
    model_data_path = get_gene_model_data_path(clean_gene, geneX$strain, geneX$data_dir)
    
    #message(sprintf("sample_path_prefix: %s", prefix))
    #message(get_gene_samples_path(clean_gene, geneX$strain, basedir=geneX$folder))
    print(sample_path)
    if(!file.exists(sample_path) | !file.exists(model_data_path)){
    
      return(full_label_list)
    }
    fit_samples = read.csv(sample_path, comment.char="#")
    model_data = readRDS(model_data_path)
    i = i + 1
    comparison_list[[i]] = list(geneX$strain, clean_gene, geneX$label,  fit_samples, model_data)
    full_label_list = c(full_label_list, geneX$strain, clean_gene)
    if (is.null(geneX$fill_palette)){
      fill_palette_list = c(fill_palette_list, fill_palette[i])
    } else {
      fill_palette_list = c(fill_palette_list, geneX$fill_palette)
    }
    
    if (is.null(geneX$border_palette)){
      border_palette_list = c(border_palette_list, border_palette[i])
    } else {
      border_palette_list = c(border_palette_list, geneX$border_palette)
    }

    # comparison_list[[i]] = list(geneX[[1]]$strain, clean_gene, fit_samples, model_data)
    # full_label_list = c(full_label_list, geneX[[1]]$strain, geneX[[1]]$gene)
  }

  if(full_label ==""){
    if(label==""){
      full_label = paste(full_label_list, collapse="_")
    } else {
      full_label = paste(c(unique(full_label_list), label), collapse ="_")
    }
  }
  
  # fill_palette = c("#747474", "#D55E00")
  # border_palette = c("#000000", "#B83502")
  # Curve
  dir.create(file.path(output_prefix, "beta_e_logistic_fits"), showWarnings = FALSE, recursive=TRUE)
  # dir.create(file.path(output_prefix, "predlogFC_logistic_fits"), showWarnings = FALSE, recursive=TRUE)
  # dir.create(file.path(output_prefix, "index_histograms"), showWarnings = FALSE, recursive=TRUE)

  
  # Beta_E
  output_path = file.path(output_prefix, "beta_e_logistic_fits", 
                          paste("plot_beta_e_logistic_fit_",
                                               full_label, ".png", sep=""))
  

  plot_multiple_fits(comparison_list, output_path, 
                     fill_palette=fill_palette_list,
                     border_palette=border_palette_list, 
                     width=width, height=height,
                     style=style, band_alpha=band_alpha,
                     str_resolution=str_resolution, summary_size=summary_size,
                     samples=samples, target="beta_e")
  
  
  
  
  
  
  
  # predlogFC
  
  # output_path = file.path(output_prefix, "predlogFC_logistic_fits", 
  #                         paste("plot_predlogFC_logistic_fit_",
  #                               full_label, ".png", sep=""))
  # plot_multiple_fits(comparison_list, output_path, 
  #                    fill_palette=fill_palette_list,
  #                    border_palette=border_palette_list, 
  #                    width=width, height=height,
  #                    style=style, band_alpha=band_alpha,
  #                    str_resolution=str_resolution, summary_size=summary_size,
  #                    samples=samples, target="logfc", include_gamma=FALSE)
  
  # Ratio
  
  
  
  # output_path = file.path(output_prefix, "ratio_histograms", 
  #                         paste("plot_ratio_fits_",
  #                     full_label, ".png", sep=""))
  # 
  # plot_multiple_ratio(comparison_list, output_path,
  #                     fill_palette=fill_palette_list,
  #                     border_palette=border_palette_list,
  #                     width=width, height=height,
  #                     min_max_path=min_max_path)  
  
  # output_path = file.path(output_prefix, "index_histograms",
  #                         paste("plot_vuln_index_",
  #                     full_label, ".png", sep=""))
  # plot_multiple_vulnerability_indexes(comparison_list, output_path,
  #                     fill_palette=fill_palette_list,
  #                     border_palette=border_palette_list,
  #                     width=width, height=height)
  
  
  
  return(full_label_list)
}





# Function to compare logistic fits of 2+ genes
plot_multiple_fits = function(comparison_list, output_path,
                              # Summary
                              summary_color = c("#262626", "#008B8B", "#D55E00", "blue"),
                              summary_size= c(3, 3, 3, 3),
                              summary_alpha= c(1, 1, 1, 1),
                              
                              # Bands
                              band_color =  c("#262626", "#609393", "#D55E00", "blue"),
                              band_size= c(1, 1, 1, 1),
                              band_alpha = c(0.02, 0.02, 0.02, 0.02),
                              band_style="lines",
                              
                              # Dot
                              dot_color = c("#262626", "#008B8B", "#D55E00", "blue"),
                              dot_size= c(2, 2, 2, 2),
                              dot_alpha= c(1, 1, 1, 1),
                              dot_style = "both",
                              
                              # Misc
                              width=10, height=10,
                              samples=1000, str_resolution = 0.01, 
                              include_gamma=TRUE, include_legend=TRUE,
                              target="beta_e",
                              y_min=NULL, y_max=NULL,
                              ylab="Fitness Cost (Estimated Beta_E)", xlab="Predicted sgRNA strength",
                              breaks=NULL, force=TRUE
                              ){
  
  
 
  
  # Skip if plot exists and not forcing 
  if(file.exists(output_path) & !force){
    return()
  } 
 
  if(target!="beta_e"){
    # y_label="Predicted log2FC at 25 generations"
    y_label=bquote("Predicted "~log[2]~"FC at 25 generations")
    x_label = "Predicted sgRNA strength"
    
    Y_BOTTOM = if (!is.null(y_min)) y_min else PREDLOGFC_BOTTOM
    Y_TOP = if (!is.null(y_max)) y_max else PREDLOGFC_TOP
    breaks = if (!is.null(breaks)) breaks else c(0, -4, -8, -12, -16, -20, -24)
  } else {
    y_label=expression(Fitness~cost~(Estimated~beta[E]))
    x_label = "Predicted sgRNA strength"
    Y_BOTTOM = if (!is.null(y_min)) y_min else BETA_E_BOTTOM
    Y_TOP = if (!is.null(y_max)) y_max else BETA_E_TOP
    breaks = if (!is.null(breaks)) breaks else  c(0, -0.2, -0.4, -0.6, -0.8, -1.0)
  }
  
  
  message("Using breaks ", breaks)
  
  g = ggplot() +  xlim(0, 1) +
    ylab(y_label) + xlab(x_label) + 
    scale_y_continuous(limits=c(Y_BOTTOM, Y_TOP), breaks=breaks)
  
  
  fill_list = c()
  border_list = c()
  full_highlight_df = data.frame()
  full_summary_df = data.frame()
  full_line_df = data.frame()
  full_point_df = data.frame()
  
  full_labels = c()
  count = 1
  gene_comp = comparison_list[[count]]
  for(gene_comp in comparison_list) {
    
    # Get data and variables
    strain = gene_comp$strain
    clean_gene = gene_comp$gene
    label = gene_comp$label
    fit_samples = gene_comp$fit_samples
    model_data = gene_comp$model_data
    
    
    # If already encountered this label, change it
    if(label %in% full_labels){
      label = paste(label, count)
    }
    
    desired_band_alpha = if (!is.null(gene_comp$band_alpha)) gene_comp$band_alpha else band_alpha[count]
    desired_band_color = if (!is.null(gene_comp$band_color)) gene_comp$band_color else band_color[count]
    desired_band_size = if (!is.null(gene_comp$band_size)) gene_comp$band_size else band_size[count]
    
    desired_summary_alpha = if (!is.null(gene_comp$summary_alpha)) gene_comp$summary_alpha else summary_alpha[count]
    desired_summary_color = if (!is.null(gene_comp$summary_color)) gene_comp$summary_color else summary_color[count]
    desired_summary_size = if (!is.null(gene_comp$summary_size)) gene_comp$summary_size else summary_size[count]
    
    desired_dot_alpha = if (!is.null(gene_comp$dot_alpha)) gene_comp$dot_alpha else dot_alpha[count]
    desired_dot_color = if (!is.null(gene_comp$dot_color)) gene_comp$dot_color else dot_color[count]
    desired_dot_size = if (!is.null(gene_comp$dot_size)) gene_comp$dot_size else dot_size[count]
    
    fill_list = c(fill_list, desired_summary_color)
    border_list = c(border_list, desired_band_color)
    
    if(!is.null( gene_comp$highlight)){
      # test
            message(sprintf("Highlighting guides!! %s", length(gene_comp)))
            highlight_df = data.frame(guides=gene_comp$highlight,
                                beta_e = colMeans(fit_samples[paste("beta_e.", gene_comp$highlight, sep="")]),
                                strength = model_data$s[gene_comp$highlight])
        
    } else {
      highlight = NULL
      highlight_df = data.frame()
    }
  
    full_highlight_df = rbind(full_highlight_df, highlight_df)
    
    if(band_style != "std" &!is.null(band_style) & band_style != "none"){
      # LINES
      S = seq(0, 1, str_resolution)
      if(target!="beta_e"){ 
        line_df = get_predlogFC_logistic_plot_lines_df(fit_samples, model_data)
      } else {
        line_df = get_beta_e_logistic_plot_lines_df(fit_samples, model_data, samples=samples)
      }
      line_df[["Gene"]] = clean_gene
      line_df[["Strain"]] = strain
      line_df[["label"]] = label
      line_df[["group"]] = paste(line_df[["variable"]], label)
      line_df[["alpha"]] = desired_band_alpha
      line_df[["linewidth"]] = desired_band_size
      line_df[["color"]] = desired_band_color
      full_line_df = rbind(full_line_df, line_df)
      
      g = g+ geom_line(data=line_df,
                       aes(x=S, y=value, group=group), color=line_df$color,
                       alpha=line_df$alpha, linewidth=line_df$linewidth)
    }
    # DOTS
    if(!is.null(dot_style) & dot_style != "none") {
      if(target!="beta_e"){ 
        point_df = get_predlogFC_logistic_plot_points_df(fit_samples, model_data)
      } else {
        point_df = get_beta_e_logistic_plot_points_df(fit_samples, model_data)
      }
      line_df[["alpha"]] = desired_dot_alpha
      point_df[["size"]] = desired_dot_size
      point_df[["color"]] = desired_dot_color
      
      if(dot_style%in%c("error", "bar", "both")){
        g = g + 
          geom_errorbar(data=point_df, aes(x = S, y = mean, ymin=lower, ymax=upper), color=point_df$color, alpha=point_df$alpha)
      }
        
        g = g + geom_point(data= point_df, aes(x = S, y = mean), size = point_df$size, 
                   color=point_df$color,
                   fill=point_df$color,  # To nake PDF save with circles filled up.
                   alpha=point_df$alpha)
    }
    
    # SUMMARY
    alpha_l = median(colMeans(fit_samples[paste0("alpha_l.",1:model_data$J)]))
    beta_l = median(colMeans(fit_samples[paste0("beta_l.",1:model_data$J)]))
    gamma = median(colMeans(fit_samples[paste0("gamma.",1:model_data$J)]))
    A = mean(fit_samples[["beta_min"]])
    K = mean(fit_samples[["beta_max"]])
    B = mean(fit_samples[["H"]])
    M = mean(fit_samples[["M"]])
    gene_gamma = median(colMeans(fit_samples[paste0("gamma.",1:model_data$J)]))
    
    
    # SD = mean(fit_samples[["beta_e_sigma"]])
    SD = 0.5
    # For summary
    BETA_E = A + (K-A) / (1+exp(-B * (S-M)))
    Y = BETA_E
    if(target=="logfc"){
      Y = twoline_single_time(25, alpha_l, beta_l, gamma, BETA_E) 
    } 
    
    
    if(band_style == "extent") {
      
      Y_max = apply(DF_l[,-1], 1, max)
      ii_too_big = Y_max > BETA_E_TOP
      Y_max[ii_too_big] = BETA_E_TOP
      
      Y_min = apply(DF_l[,-1], 1, min)
      ii_too_small = Y_min < BETA_E_BOTTOM
      Y_min[ii_too_small] = BETA_E_BOTTOM
      
    } else if(band_style=="hdi"){
      
      Y_max = apply(DF_l[,-1], 1, HDInterval::hdi)[2,]
      ii_too_big = Y_max > BETA_E_TOP
      Y_max[ii_too_big] = BETA_E_TOP
      
      Y_min = apply(DF_l[,-1], 1, HDInterval::hdi)[1,]
      ii_too_small = Y_min < BETA_E_BOTTOM
      Y_min[ii_too_small] = BETA_E_BOTTOM
      
    } else {
      Y_max = Y + 1*SD
      ii_too_big = Y_max > BETA_E_TOP
      Y_max[ii_too_big] = BETA_E_TOP
      
      Y_min = Y - 1*SD
      ii_too_small = Y_min < BETA_E_BOTTOM
      Y_min[ii_too_small] = BETA_E_BOTTOM
      }
    
    
    # summary_df = data.frame(S=S,Y=Y, Ymin = Y_min, Ymax = Y_max, Gene=clean_gene, label=label)
    
    if(target!="beta_e"){ 
      partial_summary_df = get_predlogFC_logistic_plot_summary_df(fit_samples, model_data)
    } else {
      partial_summary_df = get_beta_e_logistic_plot_summary_df(fit_samples, model_data)
    }
    partial_summary_df[["Ymin"]] = Y_min
    partial_summary_df[["Ymax"]] = Y_max
    partial_summary_df[["color"]] = label
    partial_summary_df[["alpha"]] = desired_summary_alpha
    partial_summary_df[["linewidth"]] = desired_summary_size
    
    full_summary_df = rbind(full_summary_df, partial_summary_df)
    
    
    full_labels = c(full_labels, label)

    # Draw error/noise depending on style
    # if(band_style%in% c("std", "extent", "hdi")){ 
    #   g = g + geom_ribbon(data=summary_df, 
    #                      aes(x=S, ymax = Ymax, ymin=Ymin,  fill=label),
    #                      alpha=desired_band_alpha)
    #   
    # 
    #   
    # } else if (band_style=="lines") {
    #   
    #   # g = g+ geom_line(data=line_df,
    #   #                  aes(x=S, y=value, group=variable),
    #   #                  alpha=desired_band_alpha, linewidth=2, color=desired_band_color)
    # }
    # 
    ## Include line representing gamma
    if(include_gamma){
      g_start_x = 0.01
      g_end_x = g_start_x + (gene_gamma/30.0)*(1.0-g_start_x)
      g_start_y = -1.0 + (count*0.1)
      g_end_y = g_start_y
      gamma_seg_df = data.frame(x = g_start_x, y = g_start_y, 
                                xend = g_end_x, yend = g_end_y, 
                                color=desired_summary_color)
      
      max_span = 0.25
      bar_height = 0.02
      g_start_x = 1.08
      g_end_x = g_start_x+(max_span*(gene_gamma/30.0))
      g_start_y = 0 - (count*(bar_height+0.01))
      g_end_y = g_start_y - bar_height
      gamma_seg_df = data.frame(x = g_start_x, y = g_start_y, 
                                xend = g_end_x, yend = g_end_y, 
                                color=desired_summary_color)

      # blank_rect = grid::rectGrob(gp=gpar(fill= desired_summary_color))
      # g = g + annotation_custom(grob = blank_rect, xmin = 1.1, xmax = 1.4, ymin = -0.8, ymax = -0.1)
      # 
      # 
      g = g + coord_cartesian(clip="off") + 
        annotation_custom(grob = rectGrob(gp=gpar(fill=desired_summary_color, alpha=1.0)), 
                          xmin = g_start_x, xmax = g_end_x, 
                          ymin = g_start_y, ymax = g_end_y) +
      
        annotation_custom(grob = textGrob(sprintf("%1.2f", gene_gamma)), 
                          xmin = g_end_x, xmax = g_end_x+0.05, 
                          ymin = g_start_y, ymax = g_end_y)
      
      message("Gamma segment:")
      message(sprintf("%d:\t%1.2f\t%1.2f\t%1.2f\t%1.2f\t%s",
                      count, g_start_x, g_end_x,g_start_y,g_end_y, 
                      desired_summary_color))
    }
    
    
    
    # Draw summary
    # g = g+ geom_line(data=summary_df, 
    #                  aes(x=S, y=Y, color=label),
    #                  # aes(x=S, y=Y), color=desired_summary_color,
    #                  alpha=desired_summary_alpha, linewidth=desired_summary_size)
    
    count = count + 1
    
  }  # End comparison_list loop
  
  if(band_style%in% c("std", "extent", "hdi")){ 
    g = g + geom_ribbon(data=full_summary_df, 
                        aes(x=S, ymax = Ymax, ymin=Ymin,  fill=color),
                        alpha=desired_band_alpha)
   } else if (band_style=="lines") {
    
     
    # g = g+ geom_line(data=full_line_df,
    #                  aes(x=S, y=value, group=group, color=color),
    #                  alpha=full_line_df$alpha, linewidth=full_line_df$linewidth)
  }
  
  # SUMMARY
  full_summary_df$color = factor(full_summary_df$color, levels=full_labels)
  g = g+ geom_line(data=full_summary_df, 
                   aes(x=S, y=Y, color=color),
                   alpha=full_summary_df$alpha, linewidth=full_summary_df$linewidth)
                   # aes(x=S, y=Y), color=desired_summary_color,
                   # alpha=desired_summary_alpha, linewidth=desired_summary_size)
  
  
  # Now plot points
  
  
  
  if(include_gamma){
    g = g + coord_cartesian(clip="off") + 
      annotation_custom(grob = textGrob(sprintf("Gamma:"), gp = gpar(col = "black", fontsize = 20)), 
                        xmin = 1.08, xmax = 1.16, 
                        ymin = -0.03, ymax = 0.01)
  }
  
  
  g = g + scale_color_manual(values=fill_list, 
                             name="Label",
                             breaks=full_labels,
                             labels=full_labels)
  
  if(band_style%in% c("std", "extent", "hdi")) {
    g = g + scale_fill_manual(values=fill_list, 
                              name="Label",
                              breaks=full_labels,
                            labels=full_labels)
  }
  
  g = g + guides(color = guide_legend(override.aes = list(linewidth = 4)))
  
  
  if(!is.null(highlight)){
    g = g + geom_point(data=full_highlight_df, aes(x=strength, y=beta_e), color="red", fill="red", size=4)
  }
  if(!include_legend){
    g = g + theme(legend.position = "none")
  }
  
  plot(g)
  message(sprintf("Saving to: %s", output_path))
  if(!file.exists(output_path) | force){
    ggsave(output_path, dpi=300, width = width, height=height)
  }
  
}






# Function to compare logistic fits of 2+ genes
plot_multiple_vulnerability_histograms = function(comparison_list, output_path,
                              # Summary
                              hist_color = c("#262626", "#008B8B", "#D55E00", "blue"),
                              hist_size= c(3, 3, 3, 3),
                              hist_alpha= c(0.2, 0.2, 0.2, 0.2),
                              
                              # Bands
                              border_color =  c("#121212", "#609393", "#D55E00", "blue"),
                              border_size= c(1, 1, 1, 1),
                              border_alpha = c(0.02, 0.02, 0.02, 0.02),
                              border_style="lines",
              
                              # Misc
                              width=10, height=10,
                              samples=1000, str_resolution = 0.01, 
                              include_gamma=TRUE, target="beta_e",
                              x_min=NULL, x_max=NULL,
                              x_label="Vulnerability",
                              breaks=c(0.0, -0.2, -0.4, -0.6, -0.8, -1.0),
                              bins = 150
){
  
  

  fill_list = c()
  color_list = c()
  alpha_list = c()
  full_labels = c()
  full_summary_df = data.frame()
  count = 1
  gene_comp = comparison_list[[count]]
  for(gene_comp in comparison_list) {

    
    # Get data and variables
    strain = gene_comp$strain
    clean_gene = gene_comp$gene
    label = gene_comp$label
    fit_samples = gene_comp$fit_samples
    model_data = gene_comp$model_data
    
    
    # If already encountered this label, change it
    if(label %in% full_labels){
      label = paste(label, count)
    }
    
    
    desired_hist_alpha = if (!is.null(gene_comp$hist_alpha)) gene_comp$hist_alpha else hist_alpha[count]
    desired_hist_color = if (!is.null(gene_comp$hist_color)) gene_comp$hist_color else hist_color[count]
    desired_hist_size = if (!is.null(gene_comp$hist_size)) gene_comp$hist_size else hist_size[count]
    
    desired_border_alpha = if (!is.null(gene_comp$border_alpha)) gene_comp$border_alpha else border_alpha[count]
    desired_border_color = if (!is.null(gene_comp$border_color)) gene_comp$border_color else border_color[count]
    desired_border_size = if (!is.null(gene_comp$border_size)) gene_comp$border_size else border_size[count]
    
    fill_list = c(fill_list, desired_hist_color)
    color_list = c(color_list, desired_border_color)
    alpha_list = c(alpha_list, desired_hist_alpha)
    full_labels = c(full_labels, label)

  
    # summary_df = data.frame(S=S,Y=Y, Ymin = Y_min, Ymax = Y_max, Gene=clean_gene, label=label)
    partial_hist_df = predlogFC_df = get_predlogFC_df(fit_samples, model_data, generations=25.0, gamma_bar=0.0)
    partial_hist_df[["label"]] = label
    partial_hist_df[["alpha"]] = desired_border_alpha
    
    full_summary_df = rbind(full_summary_df, partial_hist_df)
    
    

    count = count + 1
    
  }  # End comparison_list loop
  
  
  # Histogram
  full_summary_df$label = factor(full_summary_df$label, levels=full_labels)
  
  g = ggplot() +
    ylab("Density") + xlab(x_label) + 
    scale_x_continuous(limits=c(x_min, x_max))
  

  g = g + geom_histogram(data=full_summary_df, aes(y=..density.., x=vulnerability, color=label, fill=label, ),
                         position="identity", bins=bins)
  
  
  g = g + scale_alpha_manual(values=alpha_list, 
                              name="Label",
                              breaks=full_labels,
                              labels=full_labels) + 
                              
  scale_color_manual(values=color_list, 
                             name="Label",
                             breaks=full_labels,
                             labels=full_labels) +
    
  scale_fill_manual(values=fill_list, 
                             name="Label",
                             breaks=full_labels,
                             labels=full_labels)
  plot(g)

  message(sprintf("Saving to: %s", output_path))
  ggsave(output_path, dpi=300, width = width, height=height)
  
}



# Function to compare logistic fits of 2+ genes
plot_multiple_vulnerability_violins = function(comparison_list, output_path,
                                                  # Summary
                                                  hist_color = c("#262626", "#008B8B", "#D55E00", "blue"),
                                                  hist_size= c(3, 3, 3, 3),
                                                  hist_alpha= c(0.2, 0.2, 0.2, 0.2),
                                                  
                                                  # Bands
                                                  border_color =  c("#121212", "#609393", "#D55E00", "blue"),
                                                  border_size= c(1, 1, 1, 1),
                                                  border_alpha = c(0.02, 0.02, 0.02, 0.02),
                                                  border_style="lines",
                                                  
                                                  # Misc
                                                  width=10, height=10,
                                                  samples=1000, str_resolution = 0.01, 
                                                  include_gamma=TRUE, target="beta_e",
                                                  x_min=NULL, x_max=NULL,
                                                  x_label="Vulnerability",
                                                  breaks=c(0.0, -0.2, -0.4, -0.6, -0.8, -1.0),
                                                  bins = 150
){
  
  
  
  fill_list = c()
  color_list = c()
  alpha_list = c()
  full_labels = c()
  full_summary_df = data.frame()
  count = 1
  gene_comp = comparison_list[[count]]
  for(gene_comp in comparison_list) {
    
    
    # Get data and variables
    strain = gene_comp$strain
    clean_gene = gene_comp$gene
    label = gene_comp$label
    fit_samples = gene_comp$fit_samples
    model_data = gene_comp$model_data
    
    
    # If already encountered this label, change it
    if(label %in% full_labels){
      label = paste(label, count)
    }
    
    
    desired_hist_alpha = if (!is.null(gene_comp$hist_alpha)) gene_comp$hist_alpha else hist_alpha[count]
    desired_hist_color = if (!is.null(gene_comp$hist_color)) gene_comp$hist_color else hist_color[count]
    desired_hist_size = if (!is.null(gene_comp$hist_size)) gene_comp$hist_size else hist_size[count]
    
    desired_border_alpha = if (!is.null(gene_comp$border_alpha)) gene_comp$border_alpha else border_alpha[count]
    desired_border_color = if (!is.null(gene_comp$border_color)) gene_comp$border_color else border_color[count]
    desired_border_size = if (!is.null(gene_comp$border_size)) gene_comp$border_size else border_size[count]
    
    fill_list = c(fill_list, desired_hist_color)
    color_list = c(color_list, desired_border_color)
    alpha_list = c(alpha_list, desired_hist_alpha)
    full_labels = c(full_labels, label)
    
    
    # summary_df = data.frame(S=S,Y=Y, Ymin = Y_min, Ymax = Y_max, Gene=clean_gene, label=label)
    partial_hist_df = predlogFC_df = get_predlogFC_df(fit_samples, model_data, generations=25.0, gamma_bar=0.0)
    partial_hist_df[["label"]] = label
    partial_hist_df[["alpha"]] = desired_border_alpha
    
    full_summary_df = rbind(full_summary_df, partial_hist_df)
    
    
    
    count = count + 1
    
  }  # End comparison_list loop
  
  
  # Histogram
  full_summary_df$label = factor(full_summary_df$label, levels=full_labels)
  
  g = ggplot() +
    ylab("Density") + xlab(x_label) + 
    scale_x_continuous(limits=c(x_min, x_max))
  
  
  g = g + geom_histogram(data=full_summary_df, aes(y=..density.., x=vulnerability, color=label, fill=label, ),
                         position="identity", bins=bins)
  
  
  g = g + scale_alpha_manual(values=alpha_list, 
                             name="Label",
                             breaks=full_labels,
                             labels=full_labels) + 
    
    scale_color_manual(values=color_list, 
                       name="Label",
                       breaks=full_labels,
                       labels=full_labels) +
    
    scale_fill_manual(values=fill_list, 
                      name="Label",
                      breaks=full_labels,
                      labels=full_labels)
  plot(g)
  
  message(sprintf("Saving to: %s", output_path))
  ggsave(output_path, dpi=300, width = width, height=height)
  
}



# Function to compare Fmin values of 1+ genes
plot_multiple_Fmin_histograms = function(comparison_list, output_path,
                                                  # Summary
                                                  hist_color = c("#262626", "#008B8B", "#D55E00", "blue"),
                                                  hist_size= c(3, 3, 3, 3),
                                                  hist_alpha= c(0.2, 0.2, 0.2, 0.2),
                                                  
                                                  # Bands
                                                  border_color =  c("#121212", "#609393", "#D55E00", "blue"),
                                                  border_size= c(1, 1, 1, 1),
                                                  border_alpha = c(0.02, 0.02, 0.02, 0.02),
                                                  border_style="lines",
                                                  
                                                  # Misc
                                                  width=10, height=10,
                                                  samples=1000, str_resolution = 0.01, 
                                                  x_min=NULL, x_max=NULL,
                                                  hdi=TRUE,
                                                  x_label="Fmin",
                                                  bins = 150
){
  
  
  
  fill_list = c()
  color_list = c()
  alpha_list = c()
  full_labels = c()
  full_hdi_df = data.frame()
  full_summary_df = data.frame()
  count = 1
  gene_comp = comparison_list[[count]]
  for(gene_comp in comparison_list) {
    
    
    # Get data and variables
    strain = gene_comp$strain
    clean_gene = gene_comp$gene
    label = gene_comp$label
    fit_samples = gene_comp$fit_samples
    model_data = gene_comp$model_data
    
    
    # If already encountered this label, change it
    if(label %in% full_labels){
      label = paste(label, count)
    }
    
    
    desired_hist_alpha = if (!is.null(gene_comp$hist_alpha)) gene_comp$hist_alpha else hist_alpha[count]
    desired_hist_color = if (!is.null(gene_comp$hist_color)) gene_comp$hist_color else hist_color[count]
    desired_hist_size = if (!is.null(gene_comp$hist_size)) gene_comp$hist_size else hist_size[count]
    
    desired_border_alpha = if (!is.null(gene_comp$border_alpha)) gene_comp$border_alpha else border_alpha[count]
    desired_border_color = if (!is.null(gene_comp$border_color)) gene_comp$border_color else border_color[count]
    desired_border_size = if (!is.null(gene_comp$border_size)) gene_comp$border_size else border_size[count]
    
    fill_list = c(fill_list, desired_hist_color)
    color_list = c(color_list, desired_border_color)
    alpha_list = c(alpha_list, desired_hist_alpha)
    full_labels = c(full_labels, label)
    
    
    # summary_df = data.frame(S=S,Y=Y, Ymin = Y_min, Ymax = Y_max, Gene=clean_gene, label=label)
    partial_hist_df = get_Fmin_df(fit_samples, model_data, generations=25.0, gamma_bar=0.0)
    partial_hist_df[["label"]] = label
    partial_hist_df[["alpha"]] = desired_border_alpha
    full_summary_df = rbind(full_summary_df, partial_hist_df)
    
    hdi_estimate = HDInterval::hdi(partial_hist_df$Fmin)
    partial_hdi_df = data.frame(x=c(hdi_estimate[1], hdi_estimate[2]))
    partial_hdi_df[["label"]] = label
    full_hdi_df = rbind(full_hdi_df, partial_hdi_df)
    
    
    
    count = count + 1
    
  }  # End comparison_list loop
  
  
  # Histogram
  full_summary_df$label = factor(full_summary_df$label, levels=full_labels)
  
  g = ggplot() +
    ylab("Density") + xlab(x_label) + 
    scale_x_continuous(limits=c(x_min, x_max))
  
  
  g = g + geom_histogram(data=full_summary_df, aes(y=..density.., x=Fmin, color=label, fill=label, alpha=label),
                         position="identity", bins=bins)
  if(hdi){
    g = g + geom_vline(data=full_hdi_df, aes(xintercept=x, color=label, alpha=label), linetype=2, linewidth=1.2)
  }
  
  
  g = g + scale_alpha_manual(values=alpha_list, 
                             name="Label",
                             breaks=full_labels,
                             labels=full_labels) + 
    
    scale_color_manual(values=color_list, 
                       name="Label",
                       breaks=full_labels,
                       labels=full_labels) +
    
    scale_fill_manual(values=fill_list, 
                      name="Label",
                      breaks=full_labels,
                      labels=full_labels)
  plot(g)
  
  message(sprintf("Saving to: %s", output_path))
  ggsave(output_path, dpi=300, width = width, height=height)
  
}


guess_number_of_guides_from_colnames = function(colnames, sep=".", basename="alpha_l"){
  
  maxJ = length(colnames)
  if(sep=="."){
    test_col_names = paste(basename, 1:maxJ, sep=".")
  } else {
    test_col_names = paste0(basename, "[", 1:maxJ, "]")
  }
  indexes = 1:maxJ
  ii_present = test_col_names%in%colnames
  J = max(indexes[ii_present])
  return(J)
}


get_col_names = function(basename, J, sep="."){
  if(sep=="."){
    col_names = paste(basename, 1:J, sep=".")
  } else {
    col_names = paste0(basename, "[", 1:J, "]")
  }
  return (col_names)
}


identify_sep_from_colnames = function(colnames){
  if("beta_e.1" %in% colnames){
    return (".")
  } else {
    return ("[")
  }
  
}


get_predlogFC_df = function(fit_samples, model_data, generations=25.0, gamma_bar=0.0){
  
  
  beta_min = fit_samples[["beta_min"]] # beta min
  beta_max = fit_samples[["beta_max"]] # beta max
  H = fit_samples[["H"]]  # Hill
  M = fit_samples[["M"]] # M
  
  
  # Two line parameter columns
  sep = identify_sep_from_colnames(colnames(fit_samples))
  alpha_l_col_names = get_col_names("alpha_l", model_data$J, sep=sep)
  beta_l_col_names = get_col_names("beta_l", model_data$J, sep=sep)
  gamma_col_names = get_col_names("gamma", model_data$J, sep=sep)
  beta_e_col_names = get_col_names("beta_e", model_data$J, sep=sep)

  
  alpha_l = fit_samples[alpha_l_col_names]
  beta_l = fit_samples[beta_l_col_names]
  gamma = fit_samples[gamma_col_names] - gamma_bar
  n_samples = dim(fit_samples)[1]
  V = predlogFC_integral(alpha_l, beta_l, gamma, beta_min, beta_max, H, M, generations=25.0)
  df = data.frame(sample=1:n_samples, vulnerability=rowMeans(V))
  return(df)
}


get_Fmin_df = function(fit_samples, model_data, generations=25.0, gamma_bar=0.0){
  
  
  beta_min = fit_samples[["beta_min"]] # beta min
  beta_max = fit_samples[["beta_max"]] # beta max
  H = fit_samples[["H"]]  # Hill
  M = fit_samples[["M"]] # M
  
  
  # Two line parameter columns
  sep = identify_sep_from_colnames(colnames(fit_samples))
  alpha_l_col_names = get_col_names("alpha_l", model_data$J, sep=sep)
  beta_l_col_names = get_col_names("beta_l", model_data$J, sep=sep)
  gamma_col_names = get_col_names("gamma", model_data$J, sep=sep)
  beta_e_col_names = get_col_names("beta_e", model_data$J, sep=sep)
  
  alpha_l = median(colMeans(fit_samples[alpha_l_col_names]))
  beta_l = median(colMeans(fit_samples[beta_l_col_names]))
  gamma = median(colMeans(fit_samples[gamma_col_names] - gamma_bar))
  
  # alpha_l = median(colMeans(df[paste("alpha_l.",1:J, sep="")]))
  # beta_l = median(colMeans(df[paste("beta_l.",1:J,sep="")]))
  # gamma = median(colMeans(df[paste("gamma.",1:J, sep="")]))
  
  n_samples = dim(fit_samples)[1]
  
  # Get beta_E at logistic(0.0)
  betaE_S0 = logistic_curve(0.0, beta_min, beta_max, H, M)
  # Map that betaE to log2FC using twoline model
  df = data.frame(sample=1:n_samples, Fmin=twoline_single_time(generations, alpha_l, beta_l, gamma, betaE_S0))
  return(df)
}


# Plots a histograms of the vulnerability ratio
plot_multiple_vulnerability_indexes = function(comparison_list, output_path,
                               fill_palette = c("#747474", "#D55E00"),
                               border_palette = c("#747474", "#D55E00"), 
                               width=NULL, height=NULL, generations=25.0,
                               gamma_bar = 0.0){
  

  multi_hist_list = list()
  multi_hdi_list = list()
  gene_order = c()
  full_labels = c()
  for(X in comparison_list) {
    
    #print(X) 
    strain = X[[1]]
    clean_gene = X[[2]]
    label = X[[3]]
    fit_samples = X[[4]]
    model_data = X[[5]]
    
    if(label %in% full_labels){
      label = paste(label, count)
    }
    full_labels = c(full_labels, label)
    
    K = fit_samples[["beta_max"]]
    
    if(!is.null(min_max_path)){
      K = 1.0 - norm_to_unit(K[1:5000], min_x=min_max_df$min, max_x=min_max_df$max)
    }
    M = fit_samples[["M"]]
    hist_df = get_predlogFC_df(fit_samples, model_data, 
                               generations=generations, gamma_bar=gamma_bar)
    hist_df[["label"]] =  label
    gene_order = c(gene_order, label)
    
    H = HDInterval::hdi(hist_df$x)
    hdi_df = data.frame(lower=H[["lower"]], upper=H[["upper"]], label=label)
    hdi_df[["label"]] = label
    multi_hist_list[[length(multi_hist_list)+1]] = hist_df
    multi_hdi_list[[length(multi_hdi_list)+1]] = hdi_df
  }
  
  multi_hist_df = bind_rows(multi_hist_list)
  multi_hdi_df = bind_rows(multi_hdi_list)
  
  
  g = ggplot(multi_hist_df, aes(x = x, fill=label, color=label)) +
    ylab("Density") + 
    xlab("Vulnerability Index") + 
    
    geom_histogram(aes(y=..density..), position="identity", alpha=0.9, size=0.5, bins=150) +
    scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
    geom_vline(data=multi_hdi_df, aes(xintercept = lower, color=label), linewidth=1.0, linetype="dashed") +
    geom_vline(data=multi_hdi_df, aes(xintercept = upper, color=label), linewidth=1.0, linetype="dashed")
  
  
  g = g + scale_fill_manual(values=fill_palette, 
                            name="Strain",
                            breaks=full_labels,
                            labels=full_labels) +
    scale_color_manual(values=border_palette, 
                       name="Strain",
                       breaks=full_labels,
                       labels=full_labels)
  
   # plot(g)
  ggsave(output_path, dpi=300, width=width, height=height)
  
}




# Plots a histograms of the vulnerability ratio
plot_multiple_ratio = function(comparison_list, output_path,
                               fill_palette = c("#747474", "#D55E00"),
                               border_palette = c("#747474", "#D55E00"), 
                               width=NULL, height=NULL,
                               min_max_path=NULL){
  
  
  if(!is.null(min_max_path)){
    
    min_max_df = read.csv(min_max_path)
  }
  multi_hist_list = list()
  multi_hdi_list = list()
  gene_order = c()
  full_labels = c()
  for(X in comparison_list) {
   
    #print(X) 
    strain = X[[1]]
    clean_gene = X[[2]]
    label = X[[3]]
    fit_samples = X[[4]]
    model_data = X[[5]]
    
    if(label %in% full_labels){
      label = paste(label, count)
    }
    full_labels = c(full_labels, label)
    
    K = fit_samples[["beta_max"]]
    
    if(!is.null(min_max_path)){
      K = 1.0 - norm_to_unit(K[1:5000], min_x=min_max_df$min, max_x=min_max_df$max)
    }
    M = fit_samples[["M"]]
    hist_df = data.frame(x=K[1:5000]/M[1:5000])
    hist_df[["label"]] =  label
    gene_order = c(gene_order, label)
    
    H = HDInterval::hdi(hist_df$x)
    hdi_df = data.frame(lower=H[["lower"]], upper=H[["upper"]], label=label)
    hdi_df[["label"]] = label
    multi_hist_list[[length(multi_hist_list)+1]] = hist_df
    multi_hdi_list[[length(multi_hdi_list)+1]] = hdi_df
    }
  
  multi_hist_df = bind_rows(multi_hist_list)
  multi_hdi_df = bind_rows(multi_hdi_list)

  
  g = ggplot(multi_hist_df, aes(x = x, fill=label, color=label)) +
    ylab("Density") + 
    xlab("Vulnerability Ratio") + 

    geom_histogram(aes(y=..density..), position="identity", alpha=0.9, size=0.5, bins=150) +
    scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
    geom_vline(data=multi_hdi_df, aes(xintercept = lower), color=DARKGRAY_BORDER, linewidth=1.0, linetype="dashed") +
    geom_vline(data=multi_hdi_df, aes(xintercept = upper), color=DARKGRAY_BORDER, linewidth=1.0, linetype="dashed")
  
  
  g = g + scale_fill_manual(values=fill_palette, 
                               name="Strain",
                               breaks=full_labels,
                               labels=full_labels) +
    scale_color_manual(values=border_palette, 
                             name="Strain",
                             breaks=full_labels,
                             labels=full_labels)
  
  # plot(g)
  ggsave(output_path, dpi=300, width=width, height=height-4)
  
}


# Function to compare logistic fits of 2+ genes
plot_multiple_twoline_fits = function(comparison_list, output_path,
                              fill_palette = c("#747474", "#D55E00"),
                              border_palette = c("#747474", "#D55E00"), width=NULL, height=NULL){
  
  
  g = ggplot() +  xlim(0, 1) +
    ylab("sgRNA log2FC") + xlab("Generations") + 
    scale_y_continuous(limits=c(BETA_E_BOTTOM, BETA_E_TOP), breaks=c(0, -0.2, -0.4, -0.6, -0.8, -1.0))
  
  
  
  full_labels = c()
  count = 1
  
  J = comparison_list[1][[5]][["J"]]
  for(j in 1:J){
    for(X in comparison_list) {
      
      
      strain = X[[1]]
      clean_gene = X[[2]]
      label = X[[3]]
      fit_samples = X[[4]]
      model_data = X[[5]]
      # print(X)
      
      S = seq(0, 1, 0.01)
  
      alpha_l = mean(fit_samples[[sprintf("beta.%s.1", j)]])
      beta_l = mean(fit_samples[[sprintf("beta.%s.2", j)]])
      gamma = mean(fit_samples[[sprintf("beta.%s.3", j)]])
      beta_e = mean(fit_samples[[sprintf("beta_e.%s", j)]])

      ii_pam = model_data$pam==j
      data_df = data.frame(generations=model_data$x[ii_pam], 
                           Y=model_data$y[ii_pam], str=model_data$s[ii_pam])
      
      
      summary_df = data.frame(S=S,Y=Y, Gene=clean_gene, label=label)
      
      
      full_labels = c(full_labels, label)
      g = g+ geom_line(data=line_df,
                       aes(x=S, y=value, group=variable, color=label),
                       alpha=0.01, linewidth=2)
      
      g = g+ geom_line(data=summary_df, 
                       aes(x=S, y=Y,  color=label),
                       alpha=1.0, linewidth=2)
      
      count = count + 1
      
    }
    
    
    g = g + scale_color_manual(values=fill_palette, 
                               name="Strain",
                               breaks=full_labels,
                               labels=full_labels)
    
    
    plot(g)
    ggsave(output_path, dpi=300, width = width)
  }
  
}








# High-level function to make multiple plots from samples
plot_samples  = function(X, strain, base_dir="./",
                        do_animation=FALSE, desired_guides=NULL,
                        highlight=NULL, plot_M_hdi=FALSE,
                        plot_beta_max_hdi=FALSE,
                        plot_dir="./plots",
                        data_dir="./data", verbose=TRUE){
  gene = X[1]

  require(HDInterval)

  if(do_animation){
    require("animation")
    # Setting up options for animations
    ani.options(ani.res=150, ani.width=1000, ani.height=1000)
    ani.options( ani.width=1000, ani.height=1000)
  }

  # gene = "RVBD0206c:mmpL3"
  clean_gene = gsub(":", "_", gene)
  if(verbose) {message("Gene: ", gene)}
 
  # Paths
  if (verbose) {message(sprintf("basedir_data: %s", data_dir))}
  if (verbose) {message(sprintf("basedir_plot: %s", plot_dir))}
  dir.create(plot_dir, recursive=TRUE)

  sample_path = get_gene_samples_path(clean_gene, strain, data_dir)
  model_data_path = get_gene_model_data_path(clean_gene, strain, data_dir)
  
  if (verbose) {message(sprintf("sample_path: %s", sample_path))}
  if (verbose) {message(sprintf("model_data_path: %s", model_data_path))}

  # data
  fit_samples = read.csv(sample_path, comment.char="#")
  model_data = readRDS(model_data_path)
  # plotting

  # plot_ratio(clean_gene, strain, fit_samples, model_data, plot_dir)
  
  
  extended_path = file.path(base_plot_path, "beta_e_logistic_fit/")
  dir.create(extended_path, showWarnings = FALSE, recursive=TRUE)
  output_path = file.path(extended_path, paste("plot_beta_e_logistic_fit_", strain, "_", clean_gene, "_black.png", sep=""))
  plot_beta_e_logistic_fit(fit_samples, model_data, output_path,
                        highlight=highlight, plot_M_hdi=plot_M_hdi,
                        plot_beta_max_hdi=plot_beta_max_hdi)
  
  
  extended_path = file.path(base_plot_path, "predlogFC_logistic_fit/")
  dir.create(extended_path, showWarnings = FALSE, recursive=TRUE)
  output_path = file.path(extended_path, paste("plot_predlogFC_logistic_fit_", strain, "_", clean_gene, ".png", sep=""))
  
  plot_predlogFC_logistic_fit(fit_samples, model_data, output_path,
                           highlight=highlight, plot_M_hdi=plot_M_hdi,
                           plot_beta_max_hdi=plot_beta_max_hdi)
  
  
  if(do_animation){
    plot_beta_e_logistic_fit_animation(clean_gene, strain, fit_samples, model_data, plot_dir)
  }
  # plot_sigma_heatmap(clean_gene, strain, fit_samples, model_data, plot_dir)
  
  # guides = unique(c(1, model_data$pam[model_data$y==min(model_data$y)]))
  if(is.null(desired_guides)){  
    select_guides = unique(c(which.min(model_data$s), which.max(model_data$s)))
  } else {
    select_guides = desired_guides
  }
  for(j in select_guides){
  # for(j in 1:model_data$J){
    plot_twoline_fit(clean_gene, strain, fit_samples, model_data, j, plot_dir)
    if(do_animation){
      plot_twoline_fit_animation(clean_gene, strain, fit_samples, model_data, j, plot_dir)
    }
  }
}


plot_sigma_heatmap = function(gene,  strain, fit_samples, model_data, base_plot_path){
  
  X = c()
  Y = c()
  V = c()
  parameter = c("alpha_L", "beta_L", "gamma")
  
  for(i in 1:3){
    for(j in 1:3){
      X = c(X, parameter[i])
      Y = c(Y, parameter[j])
      val = mean(fit_samples[[paste("Omega",i,j, sep=".")]])
      V = c(V, val)
    }
  }
  
  heat_df = data.frame(x=X, y=Y, scale=V)
  
  ggplot(heat_df, aes(x = x, y = y, fill=scale)) +
    theme_bw()+
    # scale_x_discrete(values=c(1,2,3), labels= c("alpha_L", "beta_L", "gamma"))+
    ylab("Parameter") + xlab("Parameter") + labs(title=gene) + 
    geom_tile()
  extended_path = file.path(base_plot_path, "correlation_heatmap/")
  dir.create(extended_path, showWarnings = FALSE, recursive=TRUE)
  ggsave(file.path(extended_path, 
        paste("plot_omega_heatmap_", strain, "_", gene, ".png", sep="")), dpi=300)
}
  



# Plots the logistic fit from samples
plot_betalogistic_example = function(gene, strain, fit_samples, model_data, base_plot_path){

  S = seq(0, 1, 0.01)
  # Summary line
  DF_summary = data.frame(S=S)
  A = mean(fit_samples[["beta_min"]])
  K = mean(fit_samples[["beta_max"]])
  B = mean(fit_samples[["H"]])
  M = mean(fit_samples[["M"]])
  Y = A + (K-A) / (1+exp(-B * (S-M)))
  DF_summary = data.frame(S=S, Y=Y)

  M_hdi = HDInterval::hdi(fit_samples[["M"]])
  beta_max_hdi = HDInterval::hdi(fit_samples[["beta_max"]])
  M_hdi_df = data.frame(upper=M_hdi[2], lower=M_hdi[1], mean=M)
  beta_max_hdi_df = data.frame(upper=beta_max_hdi[2], lower=beta_max_hdi[1], mean=K)

  ggplot(DF_summary, aes(x = S, y = Y)) +
    xlim(0, 1) +  theme_bw()+
    ylab("Estimated Beta_E") + xlab("Predicted Strength") + labs(title=gene) +
    scale_y_continuous(limits=c(BETA_E_BOTTOM, BETA_E_TOP), 
                       breaks=c(0.0, -0.2, -0.4, -0.6, -0.8, -1.0)) +
    theme(axis.text = element_text(size=15), title = element_text(size=18),
          axis.title.y  = element_text(size=15, margin = margin(t = 0, r = 10, b = 0, l = 0)),
          axis.title.x  = element_text(size=15, margin = margin(t = 10, r = 0, b = 0, l = 0)),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(), panel.border = element_rect(size=2)) +
    geom_line(color="black", linewidth=2) +
    # M HDI
    geom_vline(data=M_hdi_df, aes(xintercept=upper), linetype = "dashed", color=DARKGRAY) +
    geom_vline(data=M_hdi_df, aes(xintercept=lower), linetype = "dashed", color=DARKGRAY) +
    # Beta max HDI
    geom_hline(data=beta_max_hdi_df, aes(yintercept=upper), linetype = "dashed", color=DARKGRAY) +
    geom_hline(data=beta_max_hdi_df, aes(yintercept=lower), linetype = "dashed", color=DARKGRAY)

    # geom_line(data=line_df, aes(x=S, y=value, group=variable), color="black", alpha=0.05, linewidth=2)

  extended_path = file.path(base_plot_path, "betalogistic_example/")
  dir.create(extended_path, showWarnings = FALSE, recursive=TRUE)
  ggsave(file.path(extended_path,
        paste("plot_betalogistic_example_", strain, "_", gene, "_black.png", sep="")), dpi=300)

}



get_beta_e_logistic_plot_points_df = function(fit_samples, model_data, highlight=NULL,
                                       default_color="black", default_size=2,
                                       default_alpha=0.9,
                                       highlight_color="#4444FF", 
                                       highlight_size=8.0, highlight_alpha=1.0, sep="."){
  # Summary line
  if(sep=="."){
    beta_e_col_names = paste("beta_e",1:model_data$J, sep=".")
  } else {
    beta_e_col_names = paste0("beta_e[", 1:model_data$J, "]")
  }
  
  DF_p = select(fit_samples, all_of(beta_e_col_names))
  H = HDInterval::hdi(DF_p)
  point_df = data.frame(S = model_data$s, upper=H[2,], lower=H[1,], 
                        mean=colMeans(DF_p), pam=1:model_data$J,
                        color=default_color, size=default_size, alpha=default_alpha)

  ii_highlight = point_df$pam%in%highlight
  if(!is.null(highlight)){
    point_df[ii_highlight, "size"] = highlight_size
    point_df[ii_highlight, "color"] = highlight_color
    point_df[ii_highlight, "alpha"] = highlight_alpha
  }
  
return(point_df)
  
}


get_beta_e_logistic_plot_summary_df = function(fit_samples, model_data){
  S = seq(0, 1, 0.01)
  # Summary line
  DF_summary = data.frame(S=S)
  beta_min = mean(fit_samples[["beta_min"]])
  beta_max = mean(fit_samples[["beta_max"]])
  H = mean(fit_samples[["H"]])
  M = mean(fit_samples[["M"]])
  if ("nu" %in% colnames(fit_samples)){ nu=mean(fit_samples[["nu"]]) 
  } else { nu = 1}
  # Y = beta_min + (beta_max-beta_min) / (1+exp(-H * (S-M)))
  Y = logistic_curve(S, beta_min, beta_max, H, M, nu)
  DF_summary = data.frame(S=S, Y=Y)
  return(DF_summary)
}


get_beta_e_logistic_plot_lines_df = function(fit_samples, model_data, samples=1000){
  
  S = seq(0, 1, 0.01)
  DF_l = data.frame(S=S)
  for(i in 1:samples){
    beta_min = fit_samples[["beta_min"]][i]
    beta_max = fit_samples[["beta_max"]][i]
    H = fit_samples[["H"]][i]
    M = fit_samples[["M"]][i]
    if ("nu" %in% colnames(fit_samples)){ nu=fit_samples[["nu"]][i]
    } else { nu = 1}
    # Y = beta_min + (beta_max-beta_min) / (1+exp(-H * (S-M)))
    Y = logistic_curve(S, beta_min, beta_max, H, M, nu)
    DF_l[[paste("Y", i,sep="")]] = Y
  }
  return (melt(DF_l, id = "S"))
}


# Plots the logistic fit from samples
plot_beta_e_logistic_fit = function(fit_samples, model_data, output_path="./beta_e_logistic_fit.png",
                                 width=10, height=10, highlight=NULL, plot_M_hdi=FALSE,
                                 plot_beta_max_hdi=FALSE, noplot=FALSE,
                                 highlight_color = "#4444FF",
                                 highlight_size = 8,
                                 highlight_alpha = 1.0,
                                 y_min=BETA_E_BOTTOM, y_max=BETA_E_TOP,
                                 breaks=c(0.0, -0.2, -0.4, -0.6, -0.8, -1.0)){
  
 
  point_df = get_beta_e_logistic_plot_points_df(fit_samples, model_data, highlight, 
                                         highlight_color = highlight_color, 
                                         highlight_size = highlight_size,
                                         highlight_alpha = highlight_alpha)
  line_df = get_beta_e_logistic_plot_lines_df(fit_samples, model_data)
  DF_summary = get_beta_e_logistic_plot_summary_df(fit_samples, model_data)
  
  
  M_hdi = HDInterval::hdi(fit_samples[["M"]])
  
  beta_max_hdi = HDInterval::hdi(fit_samples[["beta_max"]])
  
  beta_min = mean(fit_samples[["beta_min"]])
  beta_max = mean(fit_samples[["beta_max"]])
  H = mean(fit_samples[["H"]])
  M = mean(fit_samples[["M"]])
  
  M_hdi_df = data.frame(upper=M_hdi[2], lower=M_hdi[1], mean=M)
  beta_max_hdi_df = data.frame(upper=beta_max_hdi[2], lower=beta_max_hdi[1], mean=beta_max)
  
  
  # Plot empty and theme
  g = ggplot() + 
    xlim(0, 1) +  theme_bw()+
    ylab("Estimated Beta_E") + xlab("Predicted Strength") + labs(title=model_data$gene) + 
    scale_y_continuous(limits=c(y_min, y_max), breaks=breaks) +
    theme(axis.text = element_text(size=15), title = element_text(size=18),
          axis.title.y  = element_text(size=15, margin = margin(t = 0, r = 10, b = 0, l = 0)),
          axis.title.x  = element_text(size=15, margin = margin(t = 10, r = 0, b = 0, l = 0)),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(), panel.border = element_rect(size=2))
    
  # Now plot lines
  g = g +
    geom_line(data=line_df, aes(x = S, y = value, group=variable), color="#B0B0B0", alpha=1.00, size=2) +   # Lines
    geom_line(data=DF_summary, aes(x=S, y=Y), color="black", linewidth=2) # Summary

  # Now plot points
  g = g + 
    geom_errorbar(data=point_df, aes(x = S, y = mean, ymin=lower, ymax=upper), color=point_df$color, alpha=point_df$alpha) +
    geom_point(data= point_df, aes(x = S, y = mean), size = point_df$size, 
               color=point_df$color,
               fill=point_df$color,  # To nake PDF save with circles filled up.
               alpha=point_df$alpha)

  # Now add HDI lines if desired
  ## M HDI
  if(plot_M_hdi){
   g = g + geom_vline(data=M_hdi_df, aes(xintercept=upper), linetype = "dashed", color="black", linewidth=1.2) +
    geom_vline(data=M_hdi_df, aes(xintercept=lower), linetype = "dashed", color="black", linewidth=1.2)
  }
  ## Beta max HDI
  if(plot_beta_max_hdi){
    g = g +
    geom_hline(data=beta_max_hdi_df, aes(yintercept=upper), linetype = "dashed", color="black", linewidth=1.2) +
    geom_hline(data=beta_max_hdi_df, aes(yintercept=lower), linetype = "dashed", color="black", linewidth=1.2)
  }

  if(!noplot){
    plot(g)
    ggsave(output_path, dpi=300, width=width, height=height)
  }
return(g)
}


# Plots the logistic fit animation from samples
plot_beta_e_logistic_fit_animation = function(gene, strain, fit_samples, model_data, base_plot_path){
  
  require(animation)
  #message(base_plot_path)
  #message(paste(base_plot_path, "logistic_fit_animation_", gene, ".gif", sep=""))
  DF_p = select(fit_samples, paste("beta_e",1:model_data$J, sep="."))
  S = seq(0, 1, 0.01)
  saveGIF({
    for(i in 1:50){
      beta_min = fit_samples[["beta_min"]][i]
      beta_max = fit_samples[["beta_max"]][i]
      H = fit_samples[["H"]][i]
      M = fit_samples[["M"]][i]
      # Y = A + (K-A) / (1+exp(-B * (S-M)))
      Y = logistic_curve(S, beta_min, beta_max, H, M)
      new_l = data.frame(strength=S, Y=Y, time=i, variable=paste("y",i,sep=""))
      new_p = data.frame(beta_e = as.numeric(t(DF_p[i,])), strength=model_data$s)
      p = ggplot(new_p, aes(x = strength, y = beta_e)) +
        xlim(0, 1) +  theme_bw()+
        ylab("Estimated Beta_E") + xlab("Predicted Strength") +
        labs(title=gene, subtitle = paste("Iteration:", i)) + 
        scale_y_continuous(limits=c(BETA_E_BOTTOM, BETA_E_TOP), breaks=waiver()) +
        theme(axis.text = element_text(size=15), title = element_text(size=18),
              axis.title.y  = element_text(size=15, margin = margin(t = 0, r = 10, b = 0, l = 0)),
              axis.title.x  = element_text(size=15, margin = margin(t = 10, r = 0, b = 0, l = 0)),
              panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(), panel.border = element_rect(size=2)) +
        geom_point(color="blue", alpha=0.6, size=2) +
        geom_line(data=new_l, aes(x=strength, y=Y, group=variable), color="black", alpha=0.6, linewidth=2)
      plot(p)
      #ggsave(paste("logistic_fit_iteration_", gene, "_",sprintf("%04d", i), ".png", sep=""), dpi=300)
    }}, movie.name = paste("logistic_fit_animation_", gene, ".gif", sep=""), 
    img.name = paste("temp_", gene, sep=""))
  
}





get_predlogFC_logistic_plot_points_df = function(fit_samples, model_data, highlight=NULL,
                                                 default_color="black", default_size=2,
                                                 default_alpha=0.9,
                                                 highlight_color="#4444FF", 
                                                 highlight_size=8.0, highlight_alpha=1.0){
  
  alpha_l = median(colMeans(fit_samples[paste0("alpha_l.",1:model_data$J)]))
  beta_l = median(colMeans(fit_samples[paste0("beta_l.",1:model_data$J)]))
  gamma = median(colMeans(fit_samples[paste0("gamma.",1:model_data$J)]))
  
  # Points
  DF_p = select(fit_samples, paste("beta_e",1:model_data$J, sep="."))
  Y = twoline_single_time(25.0, alpha_l, beta_l, gamma, DF_p)
  H = HDInterval::hdi(Y)
  point_df = data.frame(S = model_data$s, upper=H[2,], lower=H[1,], 
                        mean=colMeans(Y ), pam=1:model_data$J,
                        color=default_color, size=default_size, alpha=default_alpha)
  
  ii_highlight = point_df$pam%in%highlight
  if(!is.null(highlight)){
    point_df[ii_highlight, "size"] = highlight_size
    point_df[ii_highlight, "color"] = highlight_color
    point_df[ii_highlight, "alpha"] = highlight_alpha
  }
  return(point_df)
  
}


get_predlogFC_logistic_plot_summary_df = function(fit_samples, model_data){
  S = seq(0, 1, 0.01)
  alpha_l = median(colMeans(fit_samples[paste0("alpha_l.",1:model_data$J)]))
  beta_l = median(colMeans(fit_samples[paste0("beta_l.",1:model_data$J)]))
  gamma = median(colMeans(fit_samples[paste0("gamma.",1:model_data$J)]))
  
  # Summary line
  DF_summary = data.frame(S=S)
  beta_min = mean(fit_samples[["beta_min"]])
  beta_max = mean(fit_samples[["beta_max"]])
  H = mean(fit_samples[["H"]])
  M = mean(fit_samples[["M"]])
  # Y = A + (K-A) / (1+exp(-B * (S-M)))
  beta_e = logistic_curve(S, beta_min, beta_max, H, M)
  
  Y = twoline_single_time(25.0, alpha_l, beta_l, gamma, beta_e)
  DF_summary = data.frame(S=S, Y=Y)
  return(DF_summary)
}



get_predlogFC_logistic_plot_lines_df = function(fit_samples, model_data){
  
  S = seq(0, 1, 0.01)
  DF_l = data.frame(S=S)
  
  alpha_l = median(colMeans(fit_samples[paste0("alpha_l.",1:model_data$J)]))
  beta_l = median(colMeans(fit_samples[paste0("beta_l.",1:model_data$J)]))
  gamma = median(colMeans(fit_samples[paste0("gamma.",1:model_data$J)]))
  
  
  for(i in 1:1000){
    beta_min = fit_samples[["beta_min"]][i]
    beta_max = fit_samples[["beta_max"]][i]
    H = fit_samples[["H"]][i]
    M = fit_samples[["M"]][i]
    # beta_e = A + (K-A) / (1+exp(-B * (S-M)))
    beta_e = logistic_curve(S, beta_min, beta_max, H, M)
    Y = twoline_single_time(25.0, alpha_l, beta_l, gamma, beta_e)
    
    DF_l[[paste("Y", i,sep="")]] = Y
  }
  return (melt(DF_l, id = "S"))
}




# Plots the predlogFC fit from samples
plot_predlogFC_logistic_fit = function(fit_samples, model_data, 
                                       output_path="./plot_predlogFC_logistic_fit.png",
                                       width=10, height=10, highlight=NULL, plot_M_hdi=FALSE,
                                       plot_beta_max_hdi=FALSE, noplot=FALSE,
                                       highlight_color = "#4444FF",
                                       highlight_size = 8,
                                       highlight_alpha = 1.0,
                                       y_min=PREDLOGFC_BOTTOM, y_max=PREDLOGFC_TOP,
                                       breaks=c(0.0, -4, -8, -12, -16, -20, -24)){
  
  
  point_df = get_predlogFC_logistic_plot_points_df(fit_samples, model_data, highlight, 
                                                highlight_color = highlight_color, 
                                                highlight_size = highlight_size,
                                                highlight_alpha = highlight_alpha)
  line_df = get_predlogFC_logistic_plot_lines_df(fit_samples, model_data)
  DF_summary = get_predlogFC_logistic_plot_summary_df(fit_samples, model_data)
  
  
  M_hdi = HDInterval::hdi(fit_samples[["M"]])
  
  beta_max_hdi = HDInterval::hdi(fit_samples[["beta_max"]])
  
  beta_min = mean(fit_samples[["beta_min"]])
  beta_max = mean(fit_samples[["beta_max"]])
  H = mean(fit_samples[["H"]])
  M = mean(fit_samples[["M"]])
  
  M_hdi_df = data.frame(upper=M_hdi[2], lower=M_hdi[1], mean=M)
  beta_max_hdi_df = data.frame(upper=beta_max_hdi[2], lower=beta_max_hdi[1], mean=beta_max)
  
  
  
  
  # Plot empty and theme
  g = ggplot() + 
    xlim(0, 1) +  theme_bw()+
    ylab("Estimated predicted log2FC at 25 generations") + xlab("Predicted Strength") + labs(title=model_data$gene) + 
    scale_y_continuous(limits=c(y_min, y_max), breaks=breaks) +
    theme(axis.text = element_text(size=15), title = element_text(size=18),
          axis.title.y  = element_text(size=15, margin = margin(t = 0, r = 10, b = 0, l = 0)),
          axis.title.x  = element_text(size=15, margin = margin(t = 10, r = 0, b = 0, l = 0)),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(), panel.border = element_rect(size=2))
  
  # Now plot lines
  g = g +
    geom_line(data=line_df, aes(x = S, y = value, group=variable), color="#B0B0B0", alpha=1.00, linewidth=2) +   # Lines
    geom_line(data=DF_summary, aes(x=S, y=Y), color="black", linewidth=2) # Summary
  
  # Now plot points
  g = g + 
    geom_errorbar(data=point_df, aes(x = S, y = mean, ymin=lower, ymax=upper), color=point_df$color, alpha=point_df$alpha) +
    geom_point(data= point_df, aes(x = S, y = mean), size = point_df$size, 
               color=point_df$color,
               fill=point_df$color,  # To nake PDF save with circles filled up.
               alpha=point_df$alpha)
  
  plot(g)
  
  # Now add HDI lines if desired
  ## M HDI
  if(plot_M_hdi){
    g = g + geom_vline(data=M_hdi_df, aes(xintercept=upper), linetype = "dashed", color="black", linewidth=1.2) +
      geom_vline(data=M_hdi_df, aes(xintercept=lower), linetype = "dashed", color="black", linewidth=1.2)
  }
  ## Beta max HDI
  if(FALSE){
    g = g +
      geom_hline(data=beta_max_hdi_df, aes(yintercept=upper), linetype = "dashed", color="black", linewidth=1.2) +
      geom_hline(data=beta_max_hdi_df, aes(yintercept=lower), linetype = "dashed", color="black", linewidth=1.2)
  }
  
  if(!noplot){
    plot(g)
    ggsave(output_path, dpi=300, width=width, height=height)
  }
  return(g)
  
}



predlogFC_integral = function(alpha_l, beta_l, gamma, A, B, H, M, generations=25.0){
  integral = ((alpha_l + beta_l*gamma - B*(gamma-generations)) +
                ((gamma-generations)*(A-B)*log(exp(H*(M-1))+1)) / H) - (((gamma-generations)*(A-B)*log(exp(H*(M))+1)) / H)
  return (integral)
}


# get_predlogFC_integral_df = function(fit_samples, model_data, samples=1000){
#   
#   S = seq(0, 1, 0.01)
#   DF_l = data.frame(S=S)
#   for(i in 1:samples){
#     alpha_l = fit_samples[["alpha_l"]][i]
#     beta_l = fit_samples[["beta_l"]][i]
#     gamma = fit_samples[["gamma"]][i]
#     beta_e = fit_samples[["beta_e"]][i]
#     beta_min = fit_samples[["beta_min"]][i]
#     beta_max = fit_samples[["beta_max"]][i]
#     H = fit_samples[["H"]][i]
#     M = fit_samples[["M"]][i]
#     # Y = beta_min + (beta_max-beta_min) / (1+exp(-H * (S-M)))
#     Y = logistic_curve(S, beta_min, beta_max, H, M)
#     DF_l[[paste("Y", i,sep="")]] = Y
#     
#     V = predlogFC_integral(alpha_l, beta_l, gamma, beta_min, beta_max, H, M, generations=25.0)
#     
#   }
#   return (melt(DF_l, id = "S"))
# }




first_line = function(X,a,bl,g=0,be=0){
  return(a+ bl*X)
}

second_line = function(X,a,bl,g=0,be=0){
  return(a+ bl*g + be*(X - g))
}

# Helper function describing the twoline fit.
twoline = function(X,a,bl,g,be){
  ii_L = X < g
  ii_E = X>=g
  Y = X
  Y[ii_L] = first_line(X[ii_L], a, bl, g, be)
  Y[ii_E] = second_line(X[ii_E], a, bl, g, be)
  return (Y)
}

# Helper function describing the twoline fit.
twoline_single_time = function(X, a, bl, g,be){
  ii_L = X < g
  ii_E = X>=g
  Y = X
  if (X < g){
    Y = first_line(X, a, bl, g, be)
  } else {
    Y = second_line(X, a, bl, g, be)
  }
  return (Y)
}



logistic_curve = function(S, beta_min, beta_max, H, M, nu=1){
  Y = beta_min + ((beta_max-beta_min) / ((1.0+exp(-H * (S-M)) )^(1/nu)))
  # Y = beta_min + ((beta_max-beta_min) / (1.0 + exp(-H * (S-M))) )
  return(Y)
}


hypo_logfc_sum = function(alpha_l, beta_l, gamma, beta_min, beta_max, H, M, generations=25){

    temp = ((alpha_l + beta_l*gamma - beta_max*(gamma-generations)) +
            ((gamma-generations)*(beta_min-beta_max)*log(exp(H*(M-1))+1)) / H) - (((gamma-generations)*(beta_min-beta_max)*log(exp(H*(M))+1)) / H)
    return(temp)
}

# Plots a two line fit from samples
plot_twoline_fit = function(gene, strain, fit_samples, model_data, j, base_plot_path, samples=1000){
  
  

  ii_pam = model_data$pam==j
  data_df = data.frame(generations=model_data$x[ii_pam], 
                       Y=model_data$y[ii_pam], str=model_data$s[ii_pam])
  
  X = seq(0, 30, 0.1)

  DF_l = data.frame(X=X)
  for(i in 1:samples){
    alpha_l = fit_samples[[paste("beta.",j,".1", sep="")]][i]
    beta_l = fit_samples[[paste("beta.",j,".2",sep="")]][i]
    gamma = fit_samples[[paste("beta.",j,".3", sep="")]][i]
    beta_e = fit_samples[[paste("beta_e.",j, sep="")]][i]
    Y = twoline(X,alpha_l,beta_l,gamma,beta_e)
    DF_l[[paste("Y", i,sep="")]] = Y
  }

  line_df = melt(DF_l, id = "X")


  guide_str = model_data$s[ii_pam][1]
  C = pals::coolwarm(10000)
  color_choice = C[10000*(guide_str+0.001)]   
  
  # print(j)
  # print(model_data$s[ii_pam])
  # print(data_df)
  # print(guide_str)
  # print(color_choice)
  
  ggplot(data_df, aes(x = generations, y = Y)) +
    xlim(0, 30) +  theme_bw()+
    ylab("log2 fold-change") + xlab("Generations") +
    labs(title=paste(gene, " -  guide:", j)) + 
    scale_y_continuous(limits=c(Y_MIN, Y_MAX), breaks=c(2, 0, -2, -4, -6, -8, -10, -12)) +
    theme(axis.text = element_text(size=15), title = element_text(size=18),
          axis.title.y  = element_text(size=15, margin = margin(t = 0, r = 10, b = 0, l = 0)),
          axis.title.x  = element_text(size=15, margin = margin(t = 10, r = 0, b = 0, l = 0)),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(), panel.border = element_rect(size=2)) +
    geom_line(data=line_df, aes(x=X, y=value, group=variable), color="black", alpha=0.05, linewidth=2) +
    geom_point(color=color_choice, alpha=1.0, size=2)

  extended_path = file.path(base_plot_path, "twoline_fit/")
  dir.create(extended_path, showWarnings = FALSE, recursive=TRUE)
  ggsave(file.path(extended_path, 
    paste("plot_twoline_fit_", strain, "_", gene,"_j",j,  ".png", sep="")), dpi=300)
  
}



# Plots a two line fit animation from samples
plot_twoline_fit_animation = function(gene, strain, fit_samples, model_data, j, base_plot_path){
  
  require(animation)
  #message(base_plot_path)
  #message(paste(base_plot_path, "logistic_fit_animation_", gene, ".gif", sep=""))

  X = seq(0, max(model_data$x+2), 0.1)
  ii_pam = model_data$pam==j
  data_df = data.frame(generations=model_data$x[ii_pam], Y=model_data$y[ii_pam])
  
  saveGIF({
    for(i in 1:50){
      alpha_l = fit_samples[[paste("beta.",j,".1", sep="")]][i]
      beta_l = fit_samples[[paste("beta.",j,".2",sep="")]][i]
      gamma = fit_samples[[paste("beta.",j,".3", sep="")]][i]
      beta_e = fit_samples[[paste("beta_e.",j, sep="")]][i]
      Y = twoline(X,alpha_l,beta_l,gamma,beta_e)
      new_l = data.frame(generations=X, Y=Y, time=i, variable=paste("y",i,sep=""))
      
      p = ggplot(data_df, aes(x = generations, y = Y)) +
        xlim(0, 30) +  theme_bw()+
        ylab("log2 fold-change") + xlab("Generations") +
        labs(title=paste(gene, " -  guide:", j), subtitle = paste("Iteration:", i)) + 
        scale_y_continuous(limits=c(Y_MIN, Y_MAX), breaks=c(2, 0, -2, -4, -6, -8, -10, -12)) +
        theme(axis.text = element_text(size=15), title = element_text(size=18),
              axis.title.y  = element_text(size=15, margin = margin(t = 0, r = 10, b = 0, l = 0)),
              axis.title.x  = element_text(size=15, margin = margin(t = 10, r = 0, b = 0, l = 0)),
              panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(), panel.border = element_rect(size=2)) +
        geom_point(color="blue", alpha=0.6, size=2) +
        geom_line(data=new_l, aes(x=generations, y=Y, group=variable), color="black", alpha=0.6, linewidth=2)
      plot(p)
      #ggsave(paste("logistic_fit_iteration_", gene, "_",sprintf("%04d", i), ".png", sep=""), dpi=300)
    }}, movie.name = paste("twoline_fit_animation_", gene, "_j",j, ".gif", sep=""), 
    img.name = paste("temp_", gene, sep=""))
  
}


# Plots a histogram of the vulnerability ratio
plot_ratio = function(gene, strain, fit_samples, model_data, 
                      base_plot_path, show_params=TRUE, x_lim=c(RATIO_MIN, RATIO_MAX),
                      adjust_limits=TRUE){
  
  
  K = fit_samples[["beta_max"]]
  M = fit_samples[["M"]]
  hist_df = data.frame(x=K/M)
  H = HDInterval::hdi(hist_df$x)
  
  
  if(adjust_limits & H[["lower"]] < x_lim[1]){
    x_lim[1] = min(hist_df$x)
  } 
  if(adjust_limits & H[["upper"]] > x_lim[2]) {
    x_lim[2] = max(hist_df$x)
  }

  g = ggplot(hist_df, aes(x = x)) +
    ylab("Density") + 
    xlab("Vulnerability Ratio") + labs(title=gene) + 
    xlim(x_lim[1], x_lim[2]) +
    geom_histogram(aes(y=..density..),fill=DARKGRAY, alpha=1.0, size=1, bins = 150) +
    # geom_density(alpha=.2, fill="blue") + 
    scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) + 
    geom_vline(xintercept = H[["lower"]], linewidth=1.0, linetype="dashed") +
    geom_vline(xintercept = H[["upper"]], linewidth=1.0, linetype="dashed")
  
  
  if(show_params){
    m_text = sprintf("Vulnerability Ratio: [%1.3f, %1.3f]", H[2], H[1])
    g + annotate("text",x=-Inf,y=Inf,hjust=-0.1,vjust=2,label=m_text)
  }
  
  extended_path = file.path(base_plot_path, "ratio/")
  dir.create(extended_path, showWarnings = FALSE, recursive=TRUE)
  ggsave(file.path(extended_path,
    paste("plot_vulnerability_ratio_", strain, "_", gene, ".png", sep="")), dpi=300)
  
}



