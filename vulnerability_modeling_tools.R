
# Vulnerability modeling tools ----

# Imports ----
library(parallel)

tryCatch(library(rstan), error=function(cond){message("rstan is not installed!")})
library(reshape2)


  

# Functions ----



get_prior_row = function(gene, prior_data){
  orf = strsplit(gene, ":")[[1]][1]
  ii_orf = prior_data$gene == orf
  if(sum(ii_orf) == 1){
    prior_row = prior_data[ii_orf,]
  } else {
    prior_row = NULL
  }
  return(prior_row)
}


get_gene_samples_path = function(gene, label="", basedir="./"){
  clean_gene = gsub(":", "_", gene)
  
  full_label = clean_gene
  if(label !="") {
    full_label = paste(clean_gene, label, sep="_")
  }
  filename =  paste0("sample_nb_logistic_fit_", full_label, ".txt")
  path = file.path(basedir, "samples", filename)
  return(path)
}






# Main function to  run model in parallel:
run_model = function(gene, data, strain, folder="", label="", basedir="./data", results_path = "",
                         n_chains=4, cores=1, iter=4000, warmup=1000, force=TRUE){
  message("Gene: ", gene)
  clean_gene = gsub(":", "_", gene)

  expected_samples = (iter-warmup)*n_chains

  if(results_path == ""){
    results_path = file.path(basedir, strain, folder)
  }
  dir.create(results_path, recursive=TRUE)
  dir.create(file.path(results_path, "samples"), recursive=TRUE)
  dir.create(file.path(results_path,"model_data"), recursive=TRUE)
  
  sample_file_path_prefix = get_gene_samples_path(gene, strain, results_path)
  modeldata_file_path = get_gene_model_data_path(gene, strain, results_path)
  final_sample_path = sample_file_path_prefix  # assumes sample_file ends in .txt
  
  if(!file.exists(final_sample_path) | force){

    result = tryCatch({
 
            message("Getting data...")
            model_data = get_model_data(gene, data, strain=strain)
            message(sample_file_path_prefix)
            message("Saving model data...")
            saveRDS(model_data, file = modeldata_file_path)


            combined_sample_df = data.frame()
            if(model_data$N > 0) {
              message("Fitting model...")
              fit <- sampling(nb_model, data = model_data, cores=cores,
                                      sample_file=sample_file_path_prefix,
                                      iter=iter, warmup=warmup, chains=n_chains)
              
              
              message("Saving samples...")
              for(i in 1:n_chains){
                chain_sample_path = paste0(sample_file_path_prefix, "_",  i, ".csv")
                temp_df = read.csv(chain_sample_path, comment.char = "#")
                temp_df[["chain"]] = i
                combined_sample_df = rbind(combined_sample_df, temp_df[-(1:warmup),])
                unlink(chain_sample_path)
              }
            } else {
              message("No good data. Skipping modeling.")
            }
            
            message("Saving model samples...")
            n_samples = dim(combined_sample_df)[1]
            if (n_samples == expected_samples) {
                write.csv(combined_sample_df, final_sample_path)
            } else {
                message("Error: Number of samples differed for ", clean_gene)
            }
    }, error = function(e) {
            message("Error: Problem modeling ", clean_gene)
            message("\t ", e)
    })
     
  } else {
    message("Sample file exists and not forcing. Skipping")
  }
}



get_model_data = function(desired_gene, full_raw_data, strain="H37Rv"){
  
  
  
  ii_gene = full_raw_data$orfs == desired_gene
  ii_good = full_raw_data$GOOD == "True"

  if (strain == "Smeg"){
    ii_good_gen_rep = !(full_raw_data$rep == 3 & full_raw_data$generations == 0)
    ii_select = ii_gene & ii_good & ii_good_gen_rep
  } else {
    ii_select = ii_gene & ii_good
  }
  
  n_data = sum(ii_select)
  
  # if(n_data == 0) {return(NULL)}
  
  raw_data = full_raw_data[ii_select,]
  ii_A = raw_data$atc == "minus"
  ii_B = raw_data$atc == "plus"
  
  
  strength_list = c()
  seq_list = c()
  # for(gid in unique(raw_data[["guide_idx"]])){
  for(gid in sort(unique(raw_data[["guide_group"]]))){
    ii_id = raw_data[["guide_group"]] == gid
    s = raw_data[["Strength"]][ii_id][1]
    strength_list = c(strength_list, s)
    seq = raw_data[["SEQ"]][ii_id][1]
    seq_list = c(seq_list, seq)
  }
  
  
  standata <- list(
    gene = desired_gene,
    strain = strain,
    N = sum(ii_B),
    J = length(unique(raw_data$guide_group)),
    C_A = array(raw_data[ii_A,]$data),
    C_B = array(raw_data[ii_B,]$data),
    guide_idx = array(raw_data[ii_A,]$guide_group),
    s = if (!is.null(strength_list)) array(strength_list) else array(),
    seq = if (!is.null(seq_list)) array(seq_list) else array(),
    Strength = array(raw_data[ii_A,]$Strength),
    generations = array(raw_data[ii_B,]$generations),
    
    #lambda_mu = 3, lambda_std = 1,
    
    # Mu
    alpha_l_mu_mean=0.0, alpha_l_mu_sd=1.0,
    beta_l_mu_mean=0.0, beta_l_mu_sd=1.0,
    gamma_mu_mean=5, gamma_mu_sd=2.0,
    beta_e_mu_mean=-0.5, beta_e_mu_sd=1.0,
    
    # Std
    alpha_l_std_mean=1.0, alpha_l_std_sd=5.0,
    beta_l_std_mean=1.0, beta_l_std_sd=5.0,
    gamma_std_mean=2.0, gamma_std_sd=5.0,
    beta_e_std_mean=1, beta_e_std_sd=5.0,
    
    #
    inv_phi_mean=0.001, inv_phi_sd=3,
    
    p_betamax_mean = -0.5,
    p_betamin_mean = 0.0,
    p_betamax_std = 1.0,
    p_betamin_std = 1.0,
    p_H_mean = 10,
    p_H_std = 5,
    p_M_mean = 0.5,
    
    alpha_l_mean = 0.0,
    alpha_l_std = 0.3,
    
    beta_l_mean = 0.0,
    beta_l_std = 0.5,
    
    gamma_mean = 3,
    gamma_std = 1,
    
    beta_e_mean = -0.3,
    beta_e_std = 1,
    
    
    beta_min = 0.01,
    beta_min_mean = 0.0,
    beta_min_std = 0.1,
    
    beta_max = -0.6,
    beta_max_mean = -0.6,
    beta_max_std = 0.5,
    
    H = 7,
    H_mean = 10,
    H_std = 10,
    
    M = 0.45,
    M_alpha = 40,
    M_beta = 60,

    lambda_mean = 10,
    lambda_std = 20,
    
    inv_phi_scale_A = 0.5,
    inv_phi_scale_B = 0.5,

    mean_C_A_mu = mean(raw_data[ii_A,]$data),
    mean_C_A_std = 200
    
  )
  
  return(standata)
  
  
}
