


# Vulnerability modeling - parallel

# Imports ----
source("vulnerability_modeling_tools.R")
source("vulnerability_plotting_tools.R")

get_data = function(gene, exp, strain, date, basedir){
  
  
  sample_path = get_gene_samples_path(gene, label=strain, basedir=basedir)
  model_data_path = get_gene_model_data_path(gene, label=strain, basedir=basedir)
  
  if(file.exists(sample_path) & file.exists(model_data_path)) {  
    fit_samples = read.csv(sample_path, comment.char="#")
    model_data = readRDS(model_data_path)
    model_data[["gene"]] = gene
    model_data[["strain"]] = strain
  } else {
    
   fit_samples = NULL
   model_data = NULL
  }
  return(list(fit_samples=fit_samples, model_data=model_data))
}




plot_comparisons_parallel_helper = function(comparison,
                                            summary_color = c("#262626", "#A86487", "#D55E00", "blue"),
                                            summary_size= c(3, 3, 3, 3),
                                            summary_alpha= c(1, 1, 1, 1),
                                            
                                            # Bands
                                            band_color =  c("#262626", "#A86487", "#D55E00", "blue"),
                                            band_size= c(1, 1, 1, 1),
                                            band_alpha = c(0.02, 0.02, 0.02, 0.02),
                                            band_style="lines",
                                            
                                            # Dot
                                            dot_color = c("#262626", "#A86487", "#D55E00", "blue"),
                                            dot_size= c(1, 1, 1, 1),
                                            dot_alpha= c(1, 1, 1, 1),
                                            dot_style = "both",
                                            
                                            
                                            # Summary
                                            hist_color = c("#262626", "#008B8B", "#D55E00", "blue"),
                                            hist_size= c(3, 3, 3, 3),
                                            hist_alpha= c(0.2, 0.2, 0.2, 0.2),
                                            
                                            # Bands
                                            border_color =  c("black", "#609393", "#D55E00", "blue"),
                                            border_size= c(1, 1, 1, 1),
                                            border_alpha = c(0.02, 0.02, 0.02, 0.02),
                                            
                                            
                                            
                                            width=13, height=10,
                                            samples=1000, str_resolution = 0.01, 
                                            include_gamma=TRUE, include_legend=TRUE,
                                            target="beta_e",
                                            y_min=NULL, y_max=NULL,
                                            breaks=NULL, format="png",
                                            ylab="", xlab="", safe=FALSE
){
  
  encountered_error = FALSE
  label_list = c()
  N_comp = length(comparison)
  for(i in 1:N_comp){
  
    temp_A = temp_A = get_data(comparison[[i]]$gene, comparison[[i]]$exp,  comparison[[i]]$strain, comparison[[i]]$date, comparison[[i]]$dir)
    fit_samples_A = temp_A$fit_samples
    model_data_A = temp_A$model_data
   
    if(!is.null(fit_samples_A)) { 

       if (!"beta_min" %in% colnames(fit_samples_A)){
          fit_samples_A["beta_min"] = 0
        }
        
        comparison[[i]][["fit_samples"]] = fit_samples_A
        comparison[[i]][["model_data"]] = model_data_A
        
        labelA = paste0(comparison[[i]]$strain, "_", gsub(":", "_", comparison[[i]]$gene))
        label_list = c(label_list, labelA)
    }  else {
      encountered_error = TRUE
    }

  }
  
  # temp_B = temp_A = get_data(comparison[[2]]$gene, comparison[[2]]$exp,  comparison[[2]]$strain, comparison[[2]]$date, opt$dir)
  # fit_samples_B = temp_B$fit_samples
  # model_data_B = temp_B$model_data
  # comparison[[2]][["fit_samples"]] = fit_samples_B
  # comparison[[2]][["model_data"]] = model_data_B
  # 
  
  full_label = paste(label_list, collapse = "_")
  # Beta_E
  dir.create(file.path(output_prefix, "beta_e_logistic_fits"), showWarnings = FALSE, recursive=TRUE)
  output_path = file.path(output_prefix, "beta_e_logistic_fits", 
                          paste("plot_beta_e_logistic_fit_",
                                full_label, ".", format, sep=""))
   
if(!file.exists(output_path) | !safe) {

   #message("output_path did not exist", output_path, exists(output_path), " or not safe", !safe)
 
   result = tryCatch({  
     plot_multiple_fits(comparison, output_path,
                        summary_color = summary_color,
                        summary_size = summary_size,
                        summary_alpha = summary_alpha,
                        
                        # Bands
                        band_color = band_color,
                        band_size = band_size,
                        band_alpha = band_alpha,
                        band_style = band_style,
                        
                        # Dot
                        dot_color = dot_color,
                        dot_size = dot_size,
                        dot_alpha = dot_alpha,
                        dot_style = dot_style,
                        
                        width=width, height=height,
                        samples=samples, str_resolution = str_resolution, 
                        include_gamma=include_gamma, include_legend=include_legend,
                        target=target,
                        y_min=y_min, y_max=y_max, breaks=breaks)
       
       }, error = function(e) {
   
           sample_path = get_gene_samples_path(comparison[[1]]$gene, label=comparison[[1]]$strain, basedir=comparison[[1]]$dir)
           model_data_path = get_gene_model_data_path(comparison[[1]]$gene, label=comparison[[1]]$strain, basedir=comparison[[1]]$dir)
           message("Error plotting\n\t", output_path, "\n\t", sample_path, "\n\t", model_data_path, "\n")
           message("\n\t ", e)
           encountered_error = TRUE
       }) 

} else {message("File already exists and being safe. Skipping ", output_path)}
 
 dir.create(file.path(output_prefix, "predlogFC_logistic_fits"), showWarnings = FALSE, recursive=TRUE)
 output_path = file.path(output_prefix, "predlogFC_logistic_fits", 
                         paste("plot_predlogFC_logistic_fit_",
                               full_label, ".", format, sep=""))
 if(!file.exists(output_path) | !safe) {
   result = tryCatch({  
     plot_multiple_fits(comparison, output_path,
                        summary_color = summary_color,
                        summary_size = summary_size,
                        summary_alpha = summary_alpha,
                        
                        # Bands
                        band_color = band_color,
                        band_size = band_size,
                        band_alpha = band_alpha,
                        band_style = band_style,
                        
                        # Dot
                        dot_color = dot_color,
                        dot_size = dot_size,
                        dot_alpha = dot_alpha,
                        dot_style = dot_style,
                        
                        width=width, height=height,
                        samples=samples, str_resolution = str_resolution, 
                        include_gamma=FALSE, include_legend=include_legend,
                        target="predlogFC",
                        y_min=y_min, y_max=y_max, breaks=breaks)
     
   }, error = function(e) {
     
     sample_path = get_gene_samples_path(comparison[[1]]$gene, label=comparison[[1]]$strain, basedir=comparison[[1]]$dir)
     model_data_path = get_gene_model_data_path(comparison[[1]]$gene, label=comparison[[1]]$strain, basedir=comparison[[1]]$dir)
     message("Error plotting\n\t", output_path, "\n\t", sample_path, "\n\t", model_data_path, "\n")
     message("\n\t ", e)
     encountered_error = TRUE
   }) 
 } else {message("File already exists and being safe. Skipping ", output_path)}
 
 
 # Fmin histograms
 dir.create(file.path(output_prefix, "Fmin_histograms"), showWarnings = FALSE, recursive=TRUE)
 output_path = file.path(output_prefix, "Fmin_histograms", 
                         paste("plot_Fmin_histograms_",
                               full_label, ".", format, sep=""))
 
 if(!file.exists(output_path) | !safe) {
   result = tryCatch({  
     plot_multiple_Fmin_histograms(comparison, output_path,
             # Summary
             hist_color = hist_color,
             hist_size= hist_size,
             hist_alpha= hist_alpha,
  
             # Bands
             border_color =  border_color,
             border_size= border_size,
             border_alpha = border_alpha,
             border_style="lines",
  
             # Misc
             width=10, height=10,
             samples=1000, str_resolution = 0.01,
             x_min=NULL, x_max=NULL,
             x_label="Fmin",
             bins = 150,
             hdi=TRUE)
     
   }, error = function(e) {
     
     sample_path = get_gene_samples_path(comparison[[1]]$gene, label=comparison[[1]]$strain, basedir=comparison[[1]]$dir)
     model_data_path = get_gene_model_data_path(comparison[[1]]$gene, label=comparison[[1]]$strain, basedir=comparison[[1]]$dir)
     message("Error plotting\n\t", output_path, "\n\t", sample_path, "\n\t", model_data_path, "\n")
     message("\n\t ", e)
     encountered_error = TRUE
   }) 
 
 } else {message("File already exists and being safe. Skipping ", output_path)}
 

#dir.create(file.path(output_prefix, "vulnerability_histograms"), showWarnings = FALSE, recursive=TRUE)
#output_path = file.path(output_prefix, "vulnerability_histograms", 
#                        paste("plot_vulnerability_histograms_",
#                              full_label, ".", format, sep=""))


#result = tryCatch({  
#  plot_multiple_vulnerability_histograms(comparison, output_path,
#                                         # Summary
#                                         hist_color = c("#262626", "#008B8B", "#D55E00", "blue"),
#                                         hist_size= c(3, 3, 3, 3),
#                                         hist_alpha= c(0.2, 0.2, 0.2, 0.2),
#                                         
#                                         # Bands
#                                         border_color =  c("black", "#609393", "#D55E00", "blue"),
#                                         # border_color =  c("red", "blue", "#D55E00", "blue"),
#                                         border_size= c(1, 1, 1, 1),
#                                         border_alpha = c(0.02, 0.02, 0.02, 0.02),
#                                         border_style="lines",
#                                         
#                                         # Misc
#                                         width=10, height=10,
#                                         samples=1000, str_resolution = 0.01, 
#                                         include_gamma=TRUE, target="beta_e",
#                                         x_min=NULL, x_max=NULL,
#                                         x_label="Vulnerability",
#                                         breaks=c(0.0, -0.2, -0.4, -0.6, -0.8, -1.0),
#                                         bins = 150
#                                         )
#  
#}, error = function(e) {
#  
#  sample_path = get_gene_samples_path(comparison[[1]]$gene, label=comparison[[1]]$strain, basedir=comparison[[1]]$dir)
#  model_data_path = get_gene_model_data_path(comparison[[1]]$gene, label=comparison[[1]]$strain, basedir=comparison[[1]]$dir)
#  message("Error plotting\n\t", output_path, "\n\t", sample_path, "\n\t", model_data_path, "\n")
#  message("\n\t ", e)
#}) 

return (encountered_error)
  
}


require("optparse")

# Options ----
Sys.setenv(LOCAL_CPPFLAGS = '-march=corei7 -mtune=corei7')
options(mc.cores = parallel::detectCores())



# Main ----

args = commandArgs(trailingOnly=TRUE)

# test if there is at least one argument: if not, return an error

option_list = list(
    # Data stuff:
    make_option("--strain1", type="character", default="",
              help="Strain for condition 1. Used as reference."),
    make_option("--exp1", type="character", default="",
              help="Exp for condition 1."),
    make_option("--date1", type="character", default="",
                help="Date for condition 1."),
    make_option("--label1", type="character", default="",
                help="label for the condition1."),  
    make_option("--data1", type="character", default="",
              help="Data for condition 1."),
    make_option("--dir1", type="character", default="./",
                help="Base data dir for condition 1"),
    
    make_option("--strain2", type="character", default="",
              help="Strain for condition 2. Used as reference."),
    make_option("--exp2", type="character", default="",
                help="Exp for condition 2."),
    make_option("--date2", type="character", default="",
                help="Date for condition 2."),
    make_option("--label2", type="character", default="",
                help="label for the condition 2."),  
    make_option("--data2", type="character", default="",
              help="Data for condition 2."),
    make_option("--dir2", type="character", default="./",
                help="Base data dir for condition 2"),
    
    make_option("--plot_dir", type="character", default="./",
              help="Base dir to output plots"),
    make_option("--genes", type="character", default="",
              help="Gene path"),


    #System stuff:
    make_option("--cores", type="numeric", default=15,
              help="Number of cores to use"),


    # plotting stuff:
    make_option("--ymax", type="numeric", default=0.05,
              help="Max value for the y-axis"),
    make_option("--ymin", type="numeric", default=-1.0,
              help="minimum for the y-axis"),


    make_option("--xlab", type="character", default="",
                help="Label to use for the x-axis"),

    make_option("--ylab", type="character", default="",
                help="Label to use for the y-axis"),


    
    # SUMMARY
    make_option("--summary_color1", type="character", default="#262626",
                help="Color for the summary"),
    make_option("--summary_alpha1", type="numeric", default=1,
                help="Alpha for the summary"),
    make_option("--summary_size1", type="numeric", default=3,
                help="Size for the summary"),
    
    make_option("--summary_color2", type="character", default="#A86487",
                help="Color for the summary"),
    make_option("--summary_alpha2", type="numeric", default=1,
                help="Alpha for the summary"),
    make_option("--summary_size2", type="numeric", default=3,
                help="Size for the summary"),
    
    # BANDS
    make_option("--band_color1", type="character", default="#AAAAAA",
                help="Color for the band"),
    make_option("--band_alpha1", type="numeric", default=0.1,
                help="Alpha for the band"),
    make_option("--band_size1", type="numeric", default=1,
                help="Size for the band"),
    
    make_option("--band_color2", type="character", default="#845B86",
                help="Color for the band"),
    make_option("--band_alpha2", type="numeric", default=0.1,
                help="Alpha for the band"),
    make_option("--band_size2", type="numeric", default=1,
                help="Size for the band"),
    
    
    # DOTS 
    make_option("--dot_color1", type="character", default="#262626",
                help="Color for the dots"),
    make_option("--dot_alpha1", type="numeric", default=0.9,
                help="Alpha for the dots"),
    make_option("--dot_size1", type="numeric", default=2,
                help="Size for the dots"),
    
    make_option("--dot_color2", type="character", default="#A86487",
                help="Color for the dots"),
    make_option("--dot_alpha2", type="numeric", default=0.9,
                help="Alpha for the dots"),
    make_option("--dot_size2", type="numeric", default=2,
                help="Size for the dots"),
    
    
    
    # Histograms
    make_option("--hist_color1", type="character", default="#878787",
                help="Color for the histogram bars"),
    make_option("--hist_size1", type="numeric", default=2,
                help="Size for the histogram bars"),
    make_option("--hist_alpha1", type="numeric", default=0.7,
                help="Alpha for the histogram bars"),
    
    make_option("--border_color1", type="character", default="#676767",
                help="Color for the histogram border"),
    make_option("--border_size1", type="numeric", default=2,
                help="Size for the histogram border"),
    make_option("--border_alpha1", type="numeric", default=0.7,
                help="Alpha for the histogram border"),
    
    
    make_option("--hist_color2", type="character", default="#AA86AC",
                help="Color for the histogram bars"),
    make_option("--hist_size2", type="numeric", default=2,
                help="Size for the histogram bars"),
    make_option("--hist_alpha2", type="numeric", default=0.7,
                help="Alpha for the histogram bars"),
    
    make_option("--border_color2", type="character", default="#845B86",
                help="Color for the histogram border"),
    make_option("--border_size2", type="numeric", default=2,
                help="Size for the histogram border"),
    make_option("--border_alpha2", type="numeric", default=0.7,
                help="Alpha for the histogram border"),


    
    make_option("--format", type="character", default="png",
                help="Output format"),
    
    make_option("--width", type="numeric", default=13,
                help="Width of plots"),
    
    make_option("--height", type="numeric", default=10,
                help="Width of plots"),

    make_option("--band_style", type="character", default="lines",
                help="Type of band to use"),

    make_option("--dot_style", type="character", default="both",
                help="Type of dots to use"),
    

    make_option("--hide_legend", action="store_true", default=FALSE,
                help="Hide legend"),

    make_option("--hide_gamma", action="store_true", default=FALSE,
                help="Hide gamma"),
    
    
    make_option("--safe", action="store_true", default=FALSE,
                help="Don't overwrite existing plots")

);

opt_parser = OptionParser(option_list=option_list);
opt = parse_args(opt_parser);
  

# 
# if(FALSE){
#     opt = list(strain1="H37Rv", exp1="biotinRS", date1="03_20_2023",
#           data1="/store/home/mad/vulnerability/modeling/new_vulnerability_model/result_new_normvuln_H37Rv_biotinRS_03_20_2023.txt",
#           dir1 = "/store/home/mad/vulnerability/modeling/new_vulnerability_model/results_guide_lambda/",
#           fill1="#262626",
#           border1="#262626",
# 
#           strain2="H37Rv", exp2="biotinRR", date2="03_20_2023",
#           data2="/store/home/mad/vulnerability/modeling/new_vulnerability_model/result_new_normvuln_H37Rv_biotinRR_03_20_2023.txt",
#           dir2="/store/home/mad/vulnerability/modeling/new_vulnerability_model/results_guide_lambda/",
#           fill2="#008B8B",
#           border2="#609393",
# 
#           cores=30,
#           plot_dir="/store/home/mad/vulnerability/modeling/new_vulnerability_model/results_guide_lambda/comparisons/H37Rv_biotinRR_vs_H37Rv_biotinRS/plots")
# 
# } else {
#     opt = list(strain1="Smeg", exp1="ref", date1="03_20_2023",
#           data1="/store/home/mad/vulnerability/modeling/new_vulnerability_model/result_new_normvuln_Smeg_ref_03_20_2023.txt",
#           dir1 = "/store/home/mad/vulnerability/modeling/new_vulnerability_model/results_guide_lambda/",
#           fill1="#262626",
#           border1="#262626",
# 
#           strain2="Smeg", exp2="RR1", date2="03_20_2023",
#           data2="/store/home/mad/vulnerability/modeling/new_vulnerability_model/result_new_normvuln_Smeg_RR1_03_20_2023.txt",
#           dir2="/store/home/mad/vulnerability/modeling/new_vulnerability_model/results_guide_lambda/",
#           fill2="#008B8B",
#           border2="#609393",
# 
#           cores=30,
#           plot_dir="/store/home/mad/vulnerability/modeling/new_vulnerability_model/results_guide_lambda/comparisons/Smeg_RR1_vs_Smeg_ref/plots")
# 
# }
# 
  # opt = list(strain1="H37Rv", exp1="biotinRS", date1="06_10_2023",
  #       data1="/store/home/mad/vulnerability/results/H37Rv/biotinRS/06_10_2023/data_logfc_atc_H37Rv_biotinRS_06_10_2023.txt",
  #       dir1 = "/store/home/mad/vulnerability/results/H37Rv/biotinRS/06_10_2023/modeling/vulnerability/",
  #       label1="biotinRS",
  # 
  #       strain2="H37Rv", exp2="biotinRR", date2="06_10_2023",
  #       data2="/store/home/mad/vulnerability/results/H37Rv/biotinRR/06_10_2023/data_logfc_atc_H37Rv_biotinRR_06_10_2023.txt",
  #       dir2="/store/home/mad/vulnerability/results/H37Rv/biotinRR/06_10_2023/modeling/vulnerability/",
  #       label2="biotinRR",
  # 
  #       cores=30,
  #       plot_dir="/store/home/mad/vulnerability/results/testing/plots/Smeg_RR1_vs_Smeg_ref/")

if(opt$safe){
message("Being safe, will ignore plots that already exist.")
}



desired_strain1 = opt$strain1
label1 = paste(opt$strain1,  opt$exp1, opt$date1, sep="_")

desired_strain2 = opt$strain2
label2 = paste(opt$strain2,  opt$exp2, opt$date2, sep="_")

if (!is.null(opt$genes)){
  desired_gene_path = opt$genes
} else {
  desired_gene_path = ""
}

if (file.exists(opt$data1)){
    DATA_PATH1 = opt$data1
} else {
   DATA_PATH1 = file.path(opt$dir, paste0("data_", label1, ".txt"))
}

if (file.exists(opt$data2)){
    DATA_PATH2 = opt$data2
} else {
   DATA_PATH2 = file.path(opt$dir, paste0("data_", label2, ".txt"))
}



read_gene_data = function(path){
    XFULL = read.table(path, sep="\t", stringsAsFactors = FALSE, header=T)
    if (!("GENE" %in% colnames(XFULL))){gene_col = "ORF"
    } else {gene_col = "GENE"}
    
    clean_df = data.frame(list(GENE=unique(XFULL[[gene_col]])))
    clean_df["ORFID"] = get_orf_id_from_gene_list(clean_df$GENE)
    clean_df["NAME"] = get_name_from_gene_list(clean_df$GENE)
    
    # ii_bad = is.na(XFULL$ESS)
    # XFULL$ESS[ii_bad] = "N/A"
    # XFULL[["ORF"]] = paste0(XFULL$gene, ":", XFULL$name)
    return(clean_df)
}

message(sprintf("Reading %s data...\n", label1))
message(sprintf("\t file = %s...", DATA_PATH1))
data1 = read_gene_data(DATA_PATH1)
message(sprintf("Reading %s data...", label2))
message(sprintf("\t file = %s...", DATA_PATH2))
data2 = read_gene_data(DATA_PATH2)


if (file.exists(desired_gene_path)){
    message("Taking set of genes from file: ", desired_gene_path)
        raw_unique_genes = scan(desired_gene_path, what="character")
        
} else if (!is.null(opt$genes) & opt$genes != "") {
  message("Taking set of genes from argument: ", opt$genes)
    raw_unique_genes = unlist(strsplit(opt$genes, ","))
} else {
  message("Taking set of genes from data")
    raw_unique_genes = unique(c(unique(data1$ORF), unique(data2$ORF)))
}

unique_genes = get_clean_gene_list(raw_unique_genes, data1)


N = length(unique_genes)
message(sprintf("Plotting comparison plots on all %s genes...", N))
# run_model("MSMEG4621:proB", data, desired_strain, folder=label)



# output_prefix = file.path(opt$plot_dir, "plots/comparisons", paste(label2, "vs", label1, sep="_"))
output_prefix = opt$plot_dir





desired_gene_comparisons = list()
for(i in 1:N){
  message(unique_genes[i])
  gene = unique_genes[i]
  name = strsplit(gene, ":")[[1]][2]
  
  desired_gene_comparisons[[i]] = list(

    list(strain=opt$strain1, exp=opt$exp1, gene=gene, name=name, label=paste0(name, " - ", opt$label1), dir=opt$dir1,
         # fit_samples=fit_samples_A, model_data=model_data_A,
         # Plot stuff
         summary_color=opt$summary_color1, summary_alpha=opt$summary_alpha1, summary_size=opt$summary_size1,
         band_color=opt$band_color1, band_alpha=opt$band_alpha1, band_size=opt$band_size1,
         dot_color=opt$dot_color1, dot_alpha=opt$dot_alpha1, band_size=opt$dot_size1,
         ## Histograms
         hist_color=opt$hist_color1, hist_size=opt$hist_size1, hist_alpha=opt$hist_alpha1,
         border_color=opt$border_color1, border_size=opt$border_size1, border_alpha=opt$border_alpha1
    ),
    
    list(strain=opt$strain2, exp=opt$exp2, gene=gene, name=name, label=paste0(name, " - ", opt$label2), dir=opt$dir2,
         # fit_samples=fit_samples_A, model_data=model_data_A,
         # Plot stuff
         summary_color=opt$summary_color2, summary_alpha=opt$summary_alpha2, summary_size=opt$summary_size2,
         band_color=opt$band_color2, band_alpha=opt$band_alpha2, band_size=opt$band_size2,
         dot_color=opt$dot_color2, dot_alpha=opt$dot_alpha2, band_size=opt$dot_size2, 
         ## Histograms
         hist_color=opt$hist_color2, hist_size=opt$hist_size2, hist_alpha=opt$hist_alpha2,
         border_color=opt$border_color2, border_size=opt$border_size2, border_alpha=opt$border_alpha2
    )
    )
}      


#plot_comparisons_parallel_helper(desired_gene_comparisons[[1]], width=13)



 error_results = mclapply(desired_gene_comparisons, plot_comparisons_parallel_helper, mc.cores=opt$cores,
          width=opt$width, height=opt$height,
          samples=1000, str_resolution = 0.01, 
          include_gamma=!opt$hide_gamma, include_legend=!opt$hide_legend,
          target="beta_e",
          y_min=NULL, y_max=NULL,
          breaks=NULL, mc.preschedule=TRUE, format=opt$format, dot_style=opt$dot_style, safe=opt$safe)
 

message("Encountered errors for the following genes: ")
for (i in 1:length(error_genes)){
  if(error_results[i]){
    message(desired_gene_comparisons[[i]][1]$gene)
  }
}


