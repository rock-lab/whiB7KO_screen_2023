


# Vulnerability modeling - parallel

# Imports ----
source("vulnerability_modeling_tools.R")
source("vulnerability_plotting_tools.R")


pdf(NULL)

get_data = function(gene, exp, strain, date, basedir){
  
  sample_path = get_gene_samples_path(gene, label=strain, basedir=basedir)
  model_data_path = get_gene_model_data_path(gene, label=strain, basedir=basedir)
  
  
  fit_samples = read.csv(sample_path, comment.char="#")
  model_data = readRDS(model_data_path)
  
  model_data[["gene"]] = gene
  model_data[["strain"]] = strain
  return(list(fit_samples=fit_samples, model_data=model_data))
}


plot_samples_parallel_helper = function(comparison, output_path,
                                        summary_color = c("#262626", "#008B8B", "#D55E00", "blue"),
                                        summary_size= c(3, 3, 3, 3),
                                        summary_alpha= c(1, 1, 1, 1),
                                        
                                        # Bands
                                        band_color =  c("#262626", "#609393", "#D55E00", "blue",),
                                        band_size= c(1, 1, 1, 1),
                                        band_alpha = c(0.02, 0.02, 0.02, 0.02),
                                        band_style="lines",
                                        
                                        # Dot
                                        dot_color = c("#262626", "#008B8B", "#D55E00", "blue"),
                                        dot_size= c(1, 1, 1, 1),
                                        dot_alpha= c(1, 1, 1, 1),
                                        dot_style = "both",
                                        
                                        width=10, height=10,
                                        samples=1000, str_resolution = 0.01, 
                                        include_gamma=TRUE, target="beta_e",
                                        y_min=NULL, y_max=NULL,
                                        breaks=NULL, force=FALSE, format="png"
                                        ){

  dir.create(file.path(output_prefix, "beta_e_logistic_fits"), showWarnings = FALSE, recursive=TRUE)
  labelA = paste0(comparison[[1]]$strain, "_", gsub(":", "_", comparison[[1]]$gene))
  full_label = paste0(labelA)
 

   output_path = file.path(output_prefix, "beta_e_logistic_fits", 
                          paste("plot_beta_e_logistic_fit_",
                                full_label, ".", format, sep=""))
 

 
  temp_A = get_data(comparison[[1]]$gene, comparison[[1]]$exp,  comparison[[1]]$strain, comparison[[1]]$date, opt$dir)
    
  fit_samples_A = temp_A$fit_samples
  model_data_A = temp_A$model_data
  
  if(!("beta_min" %in% colnames(fit_samples_A))){fit_samples_A["beta_min"] = 0}

  comparison[[1]][["fit_samples"]] = fit_samples_A
  comparison[[1]][["model_data"]] = model_data_A
  
 
  # Beta_E

#result = tryCatch({
#    expr
#}, warning = function(w) {
#    warning-handler-code
#}, error = function(e) {
#    error-handler-code
#}, finally = {
#    cleanup-code
#})

  
  if (file.exists(output_path)  & !force){ 
    message("File exists and not forcing. Skipping: ", output_path)
  } else {
    
result = tryCatch({
  plot_multiple_fits(comparison, output_path,
                 summary_color = summary_color,
                 summary_size = summary_size,
                 summary_alpha = summary_alpha,

                 # Bands
                 band_color = band_color,
                 band_size = band_size,
                 band_alpha = band_alpha,
                 band_style = band_style,

                 # Dot
                 dot_color = dot_color,
                 dot_size = dot_size,
                 dot_alpha = dot_alpha,
                 dot_style = dot_style,

                 width=width, height=height,
                 samples=samples, str_resolution = str_resolution,
                 include_gamma=include_gamma, target=target,
                 y_min=y_min, y_max=y_max, breaks=breaks)

    }, error = function(e) {
        message("Error plotting ", full_label)
        message("\t ", e)
    })

 }
   
 
dir.create(file.path(output_prefix, "predlogFC_logistic_fits"), showWarnings = FALSE, recursive=TRUE)
labelA = paste0(comparison[[1]]$strain, "_", gsub(":", "_", comparison[[1]]$gene))
full_label = paste0(labelA)


output_path = file.path(output_prefix, "predlogFC_logistic_fits", 
                        paste("plot_predlogFC_logistic_fit_",
                              full_label, ".", format, sep=""))

if (file.exists(output_path)  & !force){ 
  message("File exists and not forcing. Skipping: ", output_path)
} else {
result = tryCatch({
  plot_multiple_fits(comparison, output_path,
                     summary_color = summary_color,
                     summary_size = summary_size,
                     summary_alpha = summary_alpha,
                     
                     # Bands
                     band_color = band_color,
                     band_size = band_size,
                     band_alpha = band_alpha,
                     band_style = band_style,
                     
                     # Dot
                     dot_color = dot_color,
                     dot_size = dot_size,
                     dot_alpha = dot_alpha,
                     dot_style = dot_style,
                     
                     width=width, height=height,
                     samples=samples, str_resolution = str_resolution, 
                     include_gamma=FALSE, target="predlogFC",
                     y_min=y_min, y_max=y_max, breaks=breaks)
  
}, error = function(e) {
  message("Error plotting ", full_label)
  message("\t ", e)
})


 }
}


require("optparse")

# Options ----
Sys.setenv(LOCAL_CPPFLAGS = '-march=corei7 -mtune=corei7')
options(mc.cores = parallel::detectCores())



# Main ----

args = commandArgs(trailingOnly=TRUE)

# test if there is at least one argument: if not, return an error

option_list = list(
    # Data stuff:
    make_option("--strain", type="character", default="",
              help="Strain of the condition. Used as reference."),
    make_option("--exp", type="character", default="",
              help="Exp of the conditoon."),
    make_option("--date", type="character", default="",
                help="Date for the condition."),
    make_option("--label", type="character", default="",
                help="label for the condition."),   
    make_option("--data", type="character", default="",
              help="Data for the condition."),
    
    make_option("--dir", type="character", default="./",
                help="Base data dir for the condition"),

    make_option("--plot_dir", type="character", default="./",
              help="Base dir to output plots"),
    make_option("--genes", type="character", default="",
              help="Gene path"),


    #System stuff:
    make_option("--cores", type="numeric", default=15,
              help="Number of cores to use"),


    # plotting stuff:
    make_option("--ymax", type="numeric", default=0.05,
              help="Max value for the y-axis"),
    make_option("--ymin", type="numeric", default=-1.0,
              help="minimum for the y-axis"),

    
    make_option("--summary_color", type="character", default="#262626",
              help="Color for the summary"),
    make_option("--summary_alpha", type="numeric", default=1,
                help="Alpha for the summary"),
    make_option("--summary_size", type="numeric", default=3,
                help="Size for the summary"),

   
    make_option("--band_color", type="character", default="#AAAAAA",
                help="Color for the band"),
    make_option("--band_alpha", type="numeric", default=0.1,
                help="Alpha for the band"),
    make_option("--band_size", type="numeric", default=1,
                help="Size for the band"),
    make_option("--band_style", type="character", default="lines",
                help="Type of band to use"),
     
    make_option("--dot_color", type="character", default="#262626",
                help="Color for the dots"),
    make_option("--dot_alpha", type="numeric", default=0.9,
                help="Alpha for the dots"),
    make_option("--dot_size", type="numeric", default=2,
                help="Size for the dots"),
    make_option("--dot_style", type="character", default="both",
                help="Type of dots to use"),

    make_option("--format", type="character", default="png",
                help="Format of the result files")
    

);

opt_parser = OptionParser(option_list=option_list);
opt = parse_args(opt_parser);
  


# if(FALSE){
#     opt = list(strain1="H37Rv", exp1="biotinRS", date1="03_20_2023",
#           data1="/store/home/mad/vulnerability/modeling/new_vulnerability_model/result_new_normvuln_H37Rv_biotinRS_03_20_2023.txt",
#           dir1 = "/store/home/mad/vulnerability/modeling/new_vulnerability_model/results_guide_lambda/",
#           fill1="#262626",
#           border1="#262626",
# 
#           strain2="H37Rv", exp2="biotinRR", date2="03_20_2023",
#           data2="/store/home/mad/vulnerability/modeling/new_vulnerability_model/result_new_normvuln_H37Rv_biotinRR_03_20_2023.txt",
#           dir2="/store/home/mad/vulnerability/modeling/new_vulnerability_model/results_guide_lambda/",
#           fill2="#008B8B",
#           border2="#609393",
# 
#           cores=25,
#           plot_dir="/store/home/mad/vulnerability/modeling/new_vulnerability_model/results_guide_lambda/comparisons/H37Rv_biotinRR_vs_H37Rv_biotinRS/plots")
# 
# # } else {
# #     opt = list(strain1="Smeg", exp1="ref", date1="03_20_2023",
# #           data1="/store/home/mad/vulnerability/modeling/new_vulnerability_model/result_new_normvuln_Smeg_ref_03_20_2023.txt",
# #           dir1 = "/store/home/mad/vulnerability/modeling/new_vulnerability_model/results_guide_lambda/",
# #           fill1="#262626",
# #           border1="#262626",
# # 
# #           strain2="Smeg", exp2="RR1", date2="03_20_2023",
# #           data2="/store/home/mad/vulnerability/modeling/new_vulnerability_model/result_new_normvuln_Smeg_RR1_03_20_2023.txt",
# #           dir2="/store/home/mad/vulnerability/modeling/new_vulnerability_model/results_guide_lambda/",
# #           fill2="#008B8B",
# #           border2="#609393",
# # 
# #           cores=30,
# #           plot_dir="/store/home/mad/vulnerability/modeling/new_vulnerability_model/results_guide_lambda/comparisons/Smeg_RR1_vs_Smeg_ref/plots")
# # 
# # }
# 
# } else {
#   opt = list(strain1="H37Rv", exp1="RLC31_pass", date1="03_30_2023",
#              data1="/store/home/mad/vulnerability/modeling/new_vulnerability_model/result_new_normvuln_H37Rv_RLC31_pass_03_30_2023.txt",
#              dir1 = "/store/home/mad/vulnerability/modeling/new_vulnerability_model/results_guide_lambda/",
#              fill1="#262626",
#              border1="#262626",
#              label1="RLC31",
#              
#              # strain2="Smeg", exp2="RR1", date2="03_20_2023",
#              # data2="/store/home/mad/vulnerability/modeling/new_vulnerability_model/result_new_normvuln_Smeg_RR1_03_20_2023.txt",
#              # dir2="/store/home/mad/vulnerability/modeling/new_vulnerability_model/results_guide_lambda/",
#              # fill2="#008B8B",
#              # border2="#609393",
#              # 
#              cores=25,
#              plot_dir="/store/home/mad/vulnerability/modeling/new_vulnerability_model/results_guide_lambda/H37Rv/RLC31_pass/plots/")
#   
# }
# 
#     

desired_strain = opt$strain
full_label = paste(opt$strain,  opt$exp, opt$date, sep="_")

if (!is.null(opt$genes)){
  desired_gene_path = opt$genes
} else {
  desired_gene_path = ""
}

if (file.exists(opt$data)){
    DATA_PATH = opt$data
} else {
   # DATA_PATH = file.path(opt$dir, paste0("data_counts_atc", full_label, ".txt"))
}

#message("Using data (OPT)", opt$data)
message("Using data (PATH)", DATA_PATH)


read_data = function(path){
    XFULL = read.table(path, sep="\t", stringsAsFactors = FALSE, header=TRUE, comment.char = "#")
    # ii_bad = is.na(XFULL$ESS)
    # XFULL$ESS[ii_bad] = "N/A"
    # XFULL[["ORF"]] = paste0(XFULL$gene, ":", XFULL$name)
    return(XFULL)
}

message(sprintf("Reading %s data...", full_label))
data = read_data(DATA_PATH)

#message(head(data))

#message("data: ", data$ORF)

if (file.exists(desired_gene_path)){
        unique_genes = scan(desired_gene_path, what="character")
} else {
    unique_genes = unique(data$ORF)
}
 

N = length(unique_genes)
message(sprintf("Plotting comparison plots on all %s genes...", N))
# run_model("MSMEG4621:proB", data, desired_strain, folder=label)



# output_prefix = file.path(opt$plot_dir, "plots/comparisons", paste(label2, "vs", label1, sep="_"))
output_prefix = opt$plot_dir

desired_gene_comparisons = list()
for(i in 1:N){
  gene = unique_genes[i]
  name = strsplit(gene, ":")[[1]][2]
  
  desired_gene_comparisons[[i]] = list(

     list(strain=opt$strain, exp=opt$exp, gene=gene, name=name, label=paste0(name, " - ", opt$label),
                                # fit_samples=fit_samples_A, model_data=model_data_A,
                                # Plot stuff
          summary_color="#262626", summary_alpha=opt$summary_alpha, summary_size=opt$summary_size,
          band_color=opt$band_color, band_alpha=opt$band_alpha, band_size=opt$band_size,
          dot_color=opt$dot_color, dot_alpha=opt$dot_alpha, band_size=opt$dot_size
    )
    )
}      
# 
# summary_color="#262626", summary_alpha=1, summary_size=3,
# band_color=opt$band_color, band_alpha=opt$band_alpha, band_size=opt$band_size,

# 
 plot_samples_parallel_helper(desired_gene_comparisons[[2]], width=13, height=10,
    str_resolution=0.01, samples=1000, target="predlogFC",
    band_style=opt$band_style, dot_style=opt$dot_style, format=opt$format,
    y_min=NULL,
    breaks=NULL)


mclapply(desired_gene_comparisons, plot_samples_parallel_helper, mc.cores=opt$cores,
    width=13, height=10,
    str_resolution=0.01, samples=1000, target="beta_e",
    band_style=opt$band_style, dot_style=opt$dot_style,
    # y_min=-1.0,
    breaks=NULL, format=opt$format, mc.preschedule = TRUE)


